<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TradeProBuddy - Interactive Project Dashboard</title>
  <meta name="color-scheme" content="dark light" />
  <!-- Best-effort cache hints (doesn't override all hosting/browser caching, but helps) -->
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <style>
    :root{
      --bg:#0b1220;
      --card:#0f1b33;
      --card2:#0b1428;
      --ink:#e5e7eb;
      --muted:#9aa7bd;
      --line:rgba(148,163,184,.18);
      --accent:#34d399;
      --accent2:#7b3fa0;
      --danger:#ef4444;
      --warn:#f59e0b;
      --ok:#22c55e;
      --shadow:0 18px 55px rgba(0,0,0,.45);
      --r:18px;
      --r2:14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background:radial-gradient(1200px 900px at 15% 0%, rgba(123,63,160,.22), transparent 50%),
                 radial-gradient(1100px 800px at 90% 0%, rgba(52,211,153,.16), transparent 55%),
                 linear-gradient(180deg, #070b15 0%, var(--bg) 100%);
      color:var(--ink);
      min-height:100vh;
    }
    a{color:inherit}
    .wrap{max-width:1180px;margin:0 auto;padding:26px 16px 42px}
    header{
      display:flex;gap:14px;align-items:flex-start;justify-content:space-between;
      padding:18px 18px 16px;border:1px solid var(--line);border-radius:var(--r);
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      box-shadow:var(--shadow);
      position:relative;
      overflow:hidden;
    }
    header:before{
      content:"";
      position:absolute;inset:-1px;
      background:radial-gradient(800px 260px at 25% 0%, rgba(52,211,153,.12), transparent 55%),
                 radial-gradient(700px 240px at 80% 0%, rgba(123,63,160,.16), transparent 60%);
      pointer-events:none;
    }
    header > *{position:relative;z-index:1}
    .h-title{margin:0;font-size:1.25rem;letter-spacing:.2px}
      .h-sub{
        margin:6px 0 0;
        color:var(--muted);
        max-width:none;        /* remove width constraint */
        white-space:nowrap;    /* prevent wrapping */
        overflow:hidden;
        text-overflow:ellipsis; /* safety for small screens */
        display: block;
        min-width: 0;
      }

    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 12px;border-radius:999px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.18);
      color:var(--ink);
      font-size:.9rem;
      white-space:nowrap;
    }
    .pill b{font-weight:650}
    .badge{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 12px;border-radius:999px;
      border:1px solid var(--line);
      background:rgba(123,63,160,.12);
      color:var(--ink);
      font-size:.9rem;      
    }
    .build-version{
      margin-left:8px;
      font-size:0.85rem;
      color:var(--accent);
      font-weight:650;
      white-space:nowrap;
    }
    .dot{
      width:10px;height:10px;border-radius:50%;
      background:var(--accent);
      box-shadow:0 0 0 3px rgba(52,211,153,.12);
      flex:0 0 auto;
    }
    .toolbar{
      display:flex;flex-wrap:wrap;gap:10px;
      margin:14px 0 0;
    }
    .btn{
      appearance:none;border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      color:var(--ink);
      padding:10px 12px;border-radius:14px;
      cursor:pointer;
      display:inline-flex;align-items:center;gap:8px;
      font-weight:600;
      transition:transform .08s ease, background .15s ease, border-color .15s ease;
      user-select:none;
      pointer-events:auto;
    }
    .btn:hover{background:rgba(255,255,255,.06);border-color:rgba(148,163,184,.28)}
    .btn:active{transform:translateY(1px)}
    .btn.primary{
      border-color:rgba(52,211,153,.38);
      background:linear-gradient(180deg, rgba(52,211,153,.18), rgba(52,211,153,.08));
    }
    .btn.danger{
      border-color:rgba(239,68,68,.35);
      background:linear-gradient(180deg, rgba(239,68,68,.18), rgba(239,68,68,.08));
    }
    .btn.small{padding:8px 10px;border-radius:12px;font-weight:650}
    .grid{
      display:grid;gap:14px;margin-top:16px;
      grid-template-columns:repeat(12,1fr);
    }
    .card{
      grid-column:span 12;
      border:1px solid var(--line);
      border-radius:var(--r);
      background:linear-gradient(180deg, rgba(255,255,255,.035), rgba(255,255,255,.018));
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 16px;border-bottom:1px solid var(--line);
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      background:rgba(0,0,0,.15);
    }
    .card .hd h2{margin:0;font-size:1rem}
    .card .bd{padding:14px 16px}
    .kpis{
      display:grid;gap:12px;margin-top:12px;
      grid-template-columns:repeat(12,1fr);
    }
    .kpi{
      grid-column:span 12;
      border:1px solid var(--line);
      border-radius:var(--r2);
      background:rgba(0,0,0,.16);
      padding:12px 12px 11px;
    }
    .kpi .label{color:var(--muted);font-size:.85rem;margin:0 0 6px}
    .kpi .value{margin:0;font-size:1.05rem;font-weight:700;line-height:1.2}
    .kpi .sub{margin:6px 0 0;color:var(--muted);font-size:.9rem;line-height:1.35}
    @media(min-width:860px){
      .kpi{grid-column:span 4}
    }
    .tr{
      display:grid;
      grid-template-columns: 1.2fr 1fr 110px;
      gap:12px;
      padding:12px 12px;
      align-items:center;
      border:1px solid var(--line);
      border-radius:14px;
      background:rgba(0,0,0,.16);
    }
    .area{font-weight:750}
    .status{color:var(--muted);font-weight:650}
    .bar{
      height:12px;border-radius:999px;
      background:rgba(148,163,184,.12);
      border:1px solid rgba(148,163,184,.14);
      overflow:hidden;
    }
    .bar > i{
      display:block;height:100%;
      width:0%;
      background:linear-gradient(90deg, rgba(52,211,153,.75), rgba(123,63,160,.70));
    }
    .ckpts{
      margin:10px 0 0;
      padding:0 0 0 18px;
      color:var(--muted);
      line-height:1.45;
    }
    .ckpts li{margin:4px 0}
    .foot{
      margin-top:14px;
      color:var(--muted);
      font-size:.9rem;
      line-height:1.45;
    }

    /* Modal */
    .overlay{
      position:fixed;inset:0;
      background:rgba(0,0,0,.55);
      backdrop-filter: blur(10px) saturate(140%);
      display:none;
      align-items:center;justify-content:center;
      padding:26px 14px;
      z-index:1000;
      pointer-events:auto;
    }
    .overlay.show{display:flex}
    .modal{
      width:min(980px, 96vw);
      border:1px solid rgba(148,163,184,.22);
      border-radius:22px;
      background:linear-gradient(180deg, rgba(255,255,255,.055), rgba(255,255,255,.025));
      box-shadow:0 28px 80px rgba(0,0,0,.6);
      overflow:hidden;
    }
    
    .modalHeader, .modalBody, .modalFooter{
      padding-left: 24px;
      padding-right: 24px;
    }
    .modalHeader{padding-top:22px; padding-bottom:14px;}
    .modalBody{padding-top:16px; padding-bottom:16px;}
    .modalFooter{padding-top:16px; padding-bottom:22px;}
    .modalClose{ top: 16px; right: 16px; }
.modal .mh{
      display:flex;align-items:flex-start;justify-content:space-between;gap:14px;
      padding:16px 16px;border-bottom:1px solid rgba(148,163,184,.18);
      background:rgba(0,0,0,.18);
    }
    .modal .mh h3{margin:0;font-size:1.05rem}
    .modal .mh p{margin:6px 0 0;color:var(--muted);max-width:72ch}
    .x{
      appearance:none;border:1px solid rgba(148,163,184,.22);
      background:rgba(0,0,0,.25);
      color:var(--ink);
      width:40px;height:40px;border-radius:14px;
      cursor:pointer;
      font-size:18px;font-weight:800;
    }
    .x:hover{background:rgba(0,0,0,.35)}
    .modal .mb{padding:16px}
    .form{
      display:grid;
      grid-template-columns:1fr;
      gap:12px;
    }
    @media(min-width:860px){ .form.two{grid-template-columns:1fr 1fr} }
    label{display:block;font-size:.85rem;color:var(--muted);margin:0 0 6px}
    input, textarea, select{
      width:100%;
      padding:11px 12px;
      border-radius:14px;
      border:1px solid rgba(148,163,184,.20);
      background:rgba(0,0,0,.25);
      color:var(--ink);
      outline:none;
    }
    textarea{min-height:150px;resize:vertical;line-height:1.4}
    input:focus, textarea:focus, select:focus{border-color:rgba(52,211,153,.45)}
    .actions{
      display:flex;gap:10px;flex-wrap:wrap;
      justify-content:flex-end;
      padding:14px 16px;
      border-top:1px solid rgba(148,163,184,.18);
      background:rgba(0,0,0,.14);
    }
    .toast{
      position:fixed;
      right:12px;bottom:12px;
      max-width:min(520px, calc(100vw - 24px));
      padding:12px 12px;
      border-radius:16px;
      border:1px solid rgba(148,163,184,.22);
      background:rgba(2,6,23,.92);
      color:var(--ink);
      box-shadow:0 20px 60px rgba(0,0,0,.55);
      display:none;
      z-index:2000;
    }
    .toast.show{display:block}
    .toast .t{font-weight:750}
    .toast .m{margin-top:6px;color:var(--muted);line-height:1.35}

    /* Passcode gate */
    #gate{
      position:fixed;inset:0;
      z-index:3000;
      display:flex;
      align-items:center;justify-content:center;
      padding:34px 14px;
      background:radial-gradient(900px 600px at 20% 0%, rgba(123,63,160,.25), transparent 58%),
                 radial-gradient(900px 600px at 85% 0%, rgba(52,211,153,.18), transparent 60%),
                 rgba(2,6,23,.92);
      backdrop-filter: blur(12px) saturate(160%);
      pointer-events:auto;
    }
    .gate-card{
      width:min(560px, 96vw);
      border:1px solid rgba(148,163,184,.22);
      border-radius:22px;
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow:0 30px 90px rgba(0,0,0,.65);
      overflow:hidden;
    }
    .gate-card .top{padding:16px 16px;border-bottom:1px solid rgba(148,163,184,.18)}
    .gate-card h2{margin:0;font-size:1.1rem}
    .gate-card p{margin:8px 0 0;color:var(--muted);line-height:1.4}
    .gate-card .mid{padding:16px}
    .gate-row{display:flex;gap:10px;align-items:center}
    .gate-row input{flex:1}
    .err{margin-top:10px;color:#fecaca;display:none}
    .err.show{display:block}
    .hint{margin-top:12px;color:var(--muted);font-size:.9rem}
  
    /* New Branch modal (V017 fixes) */
    .btn.ghost{
      background:rgba(0,0,0,.18);
      border-color:rgba(148,163,184,.22);
    }
    .btn.ghost:hover{background:rgba(0,0,0,.28)}
    .modalHeader{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:14px;
      padding-top:22px;
      padding-bottom:14px;
      border-bottom:1px solid rgba(148,163,184,.18);
      background:rgba(0,0,0,.18);
      position:relative;
    }
    .modalTitle{
      font-size:1.05rem;
      font-weight:750;
      margin:0;
    }
    .modalSub{
      margin-top:6px;
      color:var(--muted);
      max-width:72ch;
      line-height:1.35;
      font-size:.95rem;
    }
    .iconBtn{
      appearance:none;
      border:1px solid rgba(148,163,184,.22);
      background:rgba(0,0,0,.25);
      color:var(--ink);
      width:40px;height:40px;
      border-radius:14px;
      cursor:pointer;
      font-size:18px;
      font-weight:800;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      flex:0 0 auto;
    }
    .iconBtn:hover{background:rgba(0,0,0,.35)}
    .grid2{
      display:grid;
      grid-template-columns:1fr;
      gap:12px;
    }
    @media(min-width:860px){
      .grid2{grid-template-columns:1fr 1fr;}
    }
    .field{display:block}
    .help{margin-top:6px;color:var(--muted);font-size:.85rem;line-height:1.35}
    .modalFooter{
      display:flex;
      justify-content:flex-end;
      gap:10px;
      flex-wrap:wrap;
      padding-top:16px;
      padding-bottom:22px;
      border-top:1px solid rgba(148,163,184,.18);
      background:rgba(0,0,0,.14);
    }

  </style>
</head>

<body>
  <div id="gate" aria-modal="true" role="dialog">
    <div class="gate-card">
      <div class="top">
        <h2>TradeProBuddy Dashboard</h2>
        <p><span class="dot"></span> Protected view</p>
      </div>
      <div class="mid">
        <label for="gateCode">Enter passcode</label>
        <div class="gate-row">
          <input id="gateCode" type="password" autocomplete="current-password" placeholder="Passcode" />
          <button id="gateBtn" class="btn primary" type="button">Unlock</button>
        </div>
        <div id="gateErr" class="err">Incorrect passcode. Try again.</div>
        <div class="hint">Tip: this is only front-end protection. For real security, serve behind authentication.</div>
      </div>
    </div>
  </div>

  <div class="wrap" id="app">
    <header>
      <div style="min-width: 0;">
        <h1 class="h-title">TradeProBuddy™ Project Dashboard</h1>
        <p class="h-sub">Live view + editable data (saved to your browser, exportable as <code>status.json</code>).
        <span class="build-version">• Build: V017</span>
        </p>
        <div style="display:flex;flex-wrap:wrap;gap:10px;margin-top:12px">
          <span class="pill"><span class="dot"></span><b>Owner:</b> Emile (BrainIT Consulting)</span>
          <span class="pill" title="Stored as ISO UTC in status.json; displayed here in your local time zone."><b>Updated:</b> <span id="updatedAt">-</span></span>
        </div>
      </div>
      <div style="display:flex;flex-direction:column;align-items:flex-end;gap:10px">
        <span class="badge"><span class="dot"></span><span id="overallBadge">-</span></span>
        <button class="btn small" type="button" id="btnAbout">How this works</button>
      </div>
    </header>

    <div class="toolbar" aria-label="Dashboard actions">
      <button class="btn primary" type="button" id="btnEditOverall">Edit Overall</button>
      <button class="btn" type="button" id="btnEditBranch">Edit a Branch</button>
      <button class="btn" type="button" id="btnNewBranch">New Branch</button>
      <button class="btn" type="button" id="btnImport">Import JSON</button>
      <button class="btn" type="button" id="btnExport">Export status.json</button>
      <button class="btn" type="button" id="btnServerSettings">Server Settings</button>
      <button class="btn" type="button" id="btnSyncServer">Save to Server</button>
      <button class="btn ghost" type="button" id="btnRefreshServer" title="Optional: requires Read URL in Server Settings">Refresh</button>
      <button class="btn danger" type="button" id="btnResetLocal">Reset Local</button>
    </div>

    <div class="foot" id="howItWorks" style="display:none">
      <b>How this works:</b> edits save to <code>localStorage</code> in your browser (private to your device). Use <b>Export</b> to download a <code>status.json</code> you can publish from n8n/server. <b>Load Remote</b> to pull <code>./status.json</code> from this site.
    </div>

    <div class="grid">
      <section class="card" aria-labelledby="overallTitle">
        <div class="hd">
          <h2 id="overallTitle">Overall Status</h2>
          <span class="pill" id="overallSummaryPill" style="display:none"></span>
        </div>
        <div class="bd">
          <div class="kpis">
            <div class="kpi">
              <p class="label">Headline</p>
              <p class="value" id="overallHeadline">-</p>
            </div>
            <div class="kpi">
              <p class="label">Notes</p>
              <p class="value" style="font-size:1rem;font-weight:650" id="overallNotes">-</p>
            </div>
            <div class="kpi">
              <p class="label">Rolling Forward</p>
              <p class="value" id="overallBadge2">-</p>
              <p class="sub" style="margin-top:10px" id="overallProgress">Overall progress: -</p>
              <p class="sub" id="overallSummary">-</p>
            </div>
          </div>
        </div>
      </section>

      <section class="card" aria-labelledby="branchesTitle">
        <div class="hd">
          <h2 id="branchesTitle">Progress by Branch</h2>
          <span class="pill" id="localModePill">Mode: <b>Local</b></span>
        </div>
        <div class="bd" id="branches"></div>
      </section>
    </div>

    <div class="foot">© 2025 BrainIT Consulting • TradeProBuddy™ Internal Dashboard</div>
  </div>

  <!-- MODALS -->
  <div class="overlay" id="ovOverall" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="mh">
        <div>
          <h3>Edit Overall</h3>
          <p>Saves locally. Export to publish.</p>
        </div>
        <button class="x" type="button" data-close="ovOverall">x</button>
      </div>
      <div class="mb">
        <div class="form two">
          <div>
            <label for="oBadge">Badge</label>
            <input id="oBadge" />
          </div>
          <div>
            <label for="oUpdatedAt">Updated At (ISO)</label>
            <input id="oUpdatedAt" />
          </div>
          <div style="grid-column:1/-1">
            <label for="oHeadline">Headline</label>
            <input id="oHeadline" />
          </div>
          <div style="grid-column:1/-1">
            <label for="oNotes">Notes</label>
            <textarea id="oNotes"></textarea>
          </div>
          <div style="grid-column:1/-1">
            <label for="oSummary">Optional Summary (right-card pill)</label>
            <input id="oSummary" />
          </div>
        </div>
      </div>
      <div class="actions">
        <button class="btn primary" type="button" id="saveOverall">Save</button>
        <button class="btn" type="button" data-close="ovOverall">Cancel</button>
      </div>
    </div>
  </div>

  <div class="overlay" id="ovBranch" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="mh">
        <div>
          <h3>Edit Branch</h3>
          <p>Edit status / progress / checkpoints. Use one item per line.</p>
        </div>
        <button class="x" type="button" data-close="ovBranch">x</button>
      </div>
      <div class="mb">
        <div class="form two">
          <div>
            <label for="bKey">Branch</label>
            <select id="bKey"></select>
          </div>
          <div>
            <label for="bStatus">Status</label>
            <select id="bStatus">
              <option>Planned</option>
              <option>In Progress</option>
              <option>Active</option>
              <option>Paused</option>
              <option>In Development</option>
              <option>Blocked</option>
              <option>Done</option>
            </select>
          </div>
          <div style="grid-column:1/-1">
            <label for="bProgress">Progress (0-100)</label>
            <input id="bProgress" type="number" min="0" max="100" step="1" />
          </div>
          <div style="grid-column:1/-1">
            <label for="bCkpts">Checkpoints (one per line)</label>
            <textarea id="bCkpts"></textarea>
          </div>
        </div>
      </div>
      <div class="actions">
        <button class="btn primary" type="button" id="saveBranch">Save</button>
        <button class="btn" type="button" data-close="ovBranch">Cancel</button>
      </div>
    </div>
  </div>

  <div class="overlay" id="ovImport" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="mh">
        <div>
          <h3>Import JSON</h3>
          <p>Paste a status.json object here.</p>
        </div>
        <button class="x" type="button" data-close="ovImport">x</button>
      </div>
      <div class="mb">
        <label for="importJson">JSON</label>
        <textarea id="importJson" spellcheck="false"></textarea>
      </div>
      <div class="actions">
        <button class="btn primary" type="button" id="applyImport">Apply + Save Local</button>
        <button class="btn" type="button" data-close="ovImport">Cancel</button>
      </div>
    </div>
  </div>

  <div class="overlay" id="ovExport" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="mh">
        <div>
          <h3>Export status.json</h3>
          <p>If downloads are blocked inside an embedded frame, use Copy instead.</p>
        </div>
        <button class="x" type="button" data-close="ovExport">x</button>
      </div>
      <div class="mb">
        <label for="exportJsonText">JSON (copy/paste)</label>
        <textarea id="exportJsonText" spellcheck="false" style="min-height:320px"></textarea>
        <div class="foot" style="margin-top:10px">
          Tip: paste this into <code>status.json</code> in server</div>
      </div>
      <div class="actions">
        <button class="btn primary" type="button" id="copyExport">Copy JSON</button>
        <button class="btn" type="button" id="openExportTab">Open in new tab</button>
        <button class="btn" type="button" data-close="ovExport">Close</button>
      </div>
    </div>
  </div>

  
  <div class="overlay" id="ovServer">
    <div class="modal">
      <div class="mh">
        <div>
          <h3>Server settings</h3>
          <p>Configure n8n webhook endpoints and API key.</p>
        </div>
        <button class="x" type="button" id="btnCloseServer">×</button>
      </div>

      <div class="mb">
        <div class="form two">
          <div style="grid-column:1/-1">
            <label for="svSaveUrl">Save URL (POST)</label>
            <input id="svSaveUrl" placeholder="https://YOUR-N8N/webhook/..." />
            <p class="hint">This is your n8n webhook URL for saving status.</p>
          </div>

          <div style="grid-column:1/-1">
            <label for="svReadUrl">Read URL (optional)</label>
            <input id="svReadUrl" placeholder="https://YOUR-N8N/webhook/...(optional read)" />
            <p class="hint">If you later add a read endpoint, the dashboard can fetch the latest status.</p>
          </div>

          <div style="grid-column:1/-1">
            <label for="svApiKey">API key header (x-api-key)</label>
            <input id="svApiKey" placeholder="tpb_..." />
            <p class="hint">Must match your Header Auth credential in n8n.</p>
          </div>

          <div style="grid-column:1/-1">
            <label for="svUpdatedBy">Updated by</label>
            <input id="svUpdatedBy" placeholder="dashboard" />
            <p class="hint">Saved with each revision for auditing.</p>
          </div>
        </div>

        <div class="foot" style="margin-top:16px;padding:12px;background:rgba(52,211,153,.08);border:1px solid rgba(52,211,153,.22);border-radius:12px">
          <b style="color:var(--accent)">Tip:</b> After a successful save, n8n returns the normalized <code>status</code> object so the dashboard refreshes instantly.
        </div>
      </div>

      <div class="actions">
        <button class="btn" id="btnCancelServer" type="button">Cancel</button>
        <button class="btn primary" id="btnSaveServerSettings" type="button">Save settings</button>
      </div>
    </div>
  </div>



  <!-- New Branch Overlay -->
  <div class="overlay" id="ovNewBranch" aria-hidden="true">
    <div class="modal">
      <div class="modalHeader">
        <div>
          <div class="modalTitle">Create New Branch</div>
          <div class="modalSub">Adds a new branch card and saves locally. Use “Save to Server” to persist to n8n.</div>
        </div>
        <button class="iconBtn" type="button" id="nbClose" aria-label="Close" onclick="TPB_UI.closeNewBranch(event)">✕</button>
      </div>

      <div class="modalBody">
        <div class="grid2">
          <div class="field">
            <label>Branch Key (unique)</label>
            <input id="nbKey" placeholder="e.g. qa, hubspot, crm" />
            <div class="help">Letters/numbers plus dashes and underscores only.</div>
          </div>

          <div class="field">
            <label>Status</label>
            <select id="nbStatus">
              <option>Planned</option>
              <option>In Progress</option>
              <option>In Review</option>
              <option>Blocked</option>
              <option>Active</option>
              <option>Done</option>
            </select>
          </div>

          <div class="field">
            <label>Progress (0–100)</label>
            <input id="nbProgress" type="number" min="0" max="100" step="1" value="0" />
          </div>

          <div class="field" style="grid-column:1/-1;">
            <label>Checkpoints (one per line)</label>
            <textarea id="nbCheckpoints" rows="6" placeholder="First checkpoint&#10;Second checkpoint"></textarea>
          </div>
        </div>
      </div>

      <div class="modalFooter">
        <button class="btn ghost" type="button" id="nbCancel" onclick="TPB_UI.closeNewBranch(event)">Cancel</button>
        <button class="btn primary" type="button" id="nbCreate" onclick="TPB_UI.createBranchFromForm(event)">Create Branch</button>
      </div>
    </div>
  </div>


<script>
(() => {
  "use strict";

  // ============================================================
  // Helper: $ shorthand
  // ============================================================
  const $ = (id) => document.getElementById(id);

  // ============================================================
  // Storage keys
  // ============================================================
  const STORAGE_KEY = "tpb_status_v1";
  const PASS_KEY = "tpb_gate_ok_v1";

  // Server sync (n8n)
  const SV_SAVE_URL_KEY = "tpb_sv_save_url_v1";
  const SV_READ_URL_KEY = "tpb_sv_read_url_v1";
  const SV_API_KEY_KEY  = "tpb_sv_api_key_v1";
  const SV_UPDATED_BY_KEY = "tpb_sv_updated_by_v1";

  // Passcode
  const PASSCODE = "tradepro";

  // ============================================================
  // State
  // ============================================================
  let STATE = {
    overall: {
      badge: "On Track",
      headline: "All systems operational",
      notes: "No blocking issues",
      summary: ""
    },
    branches: {},
    updatedAt: new Date().toISOString()
  };

  // ============================================================
  // LocalStorage helpers
  // ============================================================
  function saveLocal(data) {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    } catch (e) {
      console.error("Failed to save to localStorage:", e);
    }
  }

  function persistLocal(){
    saveLocal(STATE);
  }

  
    // ----------------------------
    // New Branch (local + server)
    // ----------------------------
    function openNewBranch(ev) {
      try { ev?.preventDefault?.(); } catch {}
      const ov = $("ovNewBranch");
      if (!ov) return;
      $("nbKey").value = "";
      $("nbStatus").value = "Planned";
      $("nbProgress").value = 0;
      $("nbCheckpoints").value = "";
      ov.classList.add("show");
      ov.setAttribute("aria-hidden", "false");
      setTimeout(() => $("nbKey")?.focus?.(), 50);
    }

    function closeNewBranch(ev) {
      try { ev?.preventDefault?.(); ev?.stopPropagation?.(); } catch {}
      const ov = $("ovNewBranch");
      if (!ov) return;
      ov.classList.remove("show");
      ov.setAttribute("aria-hidden", "true");
    }

    function sanitizeBranchKey(raw) {
      const s = String(raw || "").trim();
      // allow letters/numbers/_/-
      return s.toLowerCase()
        .replace(/[^a-z0-9_-]+/g, "-")
        .replace(/^-+/, "")
        .replace(/-+$/, "");
    }

    function splitLinesToArray(text) {
      return String(text || "")
        .split("\n")
        .map(s => s.trim())
        .filter(Boolean);
    }

    function createBranchFromForm(ev){
  try { ev?.preventDefault?.(); } catch {}
  const rawKey = ($("nbKey")?.value || "").trim();
  const key = sanitizeBranchKey(rawKey);
  const status = ($("nbStatus")?.value || "Planned").trim() || "Planned";
  const progress = clampInt(($("nbProgress")?.value ?? "0"), 0, 100);
  const checkpoints = splitLinesToArray($("nbCheckpoints")?.value || "");

  if (!key){
    toast("Please enter a branch key (letters/numbers/dashes/underscores).", "warn");
    try { $("nbKey")?.focus?.(); } catch {}
    return;
  }

  STATE.branches = STATE.branches && typeof STATE.branches === "object" ? STATE.branches : {};
  if (STATE.branches[key]){
    toast(`Branch "${key}" already exists. Pick a different key.`, "warn");
    try { $("nbKey")?.focus?.(); } catch {}
    return;
  }

  STATE.branches[key] = { status, progress, checkpoints };
  STATE.updatedAt = new Date().toISOString();

  // Persist locally
  persistLocal();

  // Refresh UI immediately
  try { renderAll(); } catch {}

  // Close modal
  closeNewBranch();

  toast(`Created branch: ${key}`, "ok");
}

// Expose a tiny UI API (makes buttons reliable even if listeners fail)
window.TPB_UI = {
  openNewBranch,
  closeNewBranch,
  createBranchFromForm,
};




function loadLocal() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw) return JSON.parse(raw);
    } catch (e) {
      console.error("Failed to load from localStorage:", e);
    }
    return null;
  }

  function getServerSettings() {
    try {
      return {
        saveUrl: localStorage.getItem(SV_SAVE_URL_KEY) || "",
        readUrl: localStorage.getItem(SV_READ_URL_KEY) || "",
        apiKey: localStorage.getItem(SV_API_KEY_KEY) || "",
        updatedBy: localStorage.getItem(SV_UPDATED_BY_KEY) || "dashboard"
      };
    } catch {
      return { saveUrl: "", readUrl: "", apiKey: "", updatedBy: "dashboard" };
    }
  }

  function setServerSettings(cfg) {
    try {
      localStorage.setItem(SV_SAVE_URL_KEY, cfg.saveUrl || "");
      localStorage.setItem(SV_READ_URL_KEY, cfg.readUrl || "");
      localStorage.setItem(SV_API_KEY_KEY, cfg.apiKey || "");
      localStorage.setItem(SV_UPDATED_BY_KEY, cfg.updatedBy || "dashboard");
    } catch (e) {
      console.error("Failed to save server settings:", e);
    }
  }

  // ============================================================
  // Passcode gate
  // ============================================================
  const gateOverlay = $("gate");
  const gateInput   = $("gateCode");
  const gateBtn     = $("gateBtn");
  const gateErr     = $("gateErr");

  function setGateError(msg) {
    if (!gateErr) return;
    gateErr.textContent = msg || "";
    gateErr.style.display = msg ? "block" : "none";
  }

  function lockApp() {
    try { localStorage.removeItem(PASS_KEY); } catch {}
    if (gateOverlay) gateOverlay.style.display = "flex";
    setGateError("");
    if (gateInput) gateInput.value = "";
    setTimeout(() => gateInput?.focus(), 0);
  }

  function unlockApp() {
    try { localStorage.setItem(PASS_KEY, "1"); } catch {}
    if (gateOverlay) gateOverlay.style.display = "none";
    setGateError("");
    renderAll();
    toast("Unlocked successfully");
  }

  function attemptUnlock() {
    const v = (gateInput?.value || "").trim();
    if (!v) {
      setGateError("Enter passcode.");
      gateInput?.focus();
      return;
    }
    if (v === PASSCODE) {
      unlockApp();
      return;
    }
    setGateError("Incorrect passcode.");
    gateInput?.select();
  }

  // Wire gate events
  if (gateBtn) gateBtn.addEventListener("click", (e) => { e.preventDefault(); attemptUnlock(); });
  if (gateInput) gateInput.addEventListener("keydown", (e) => { if (e.key === "Enter") { e.preventDefault(); attemptUnlock(); } });

  // Auto-unlock if previously unlocked
  try {
    const ok = localStorage.getItem(PASS_KEY);
    if (ok === "1") unlockApp(); else lockApp();
  } catch {
    lockApp();
  }

  // ============================================================
  // Utility functions
  // ============================================================
  function esc(str) {
    const div = document.createElement("div");
    div.textContent = str;
    return div.innerHTML;
  }

  function clamp(val, min, max) {
    return Math.max(min, Math.min(max, val));
  }

  function clampInt(val, min, max) {
    const n = parseInt(val, 10);
    return clamp(Number.isFinite(n) ? n : 0, min, max);
  }

  function normalizeCheckpoints(text) {
    return text.split("\n").map(s => s.trim()).filter(Boolean);
  }

  function normalizeState(raw) {
    return {
      overall: raw.overall || STATE.overall,
      branches: raw.branches || {},
      updatedAt: raw.updatedAt || new Date().toISOString()
    };
  }

  // ============================================================
  // Toast
  // ============================================================
  let toastTimeout;
  function toast(msg, kind) {
    const el = document.createElement("div");
    el.className = "toast show";
    const k = String(kind || "").toLowerCase();
    const tag = k ? ` <span style="color:${k==='ok'?'var(--ok)':k==='warn'?'var(--warn)':k==='danger'?'var(--danger)':'var(--accent)'};font-weight:800">•</span>` : "";
    el.innerHTML = `<div class="t">${esc(msg)}${tag}</div>`;
    document.body.appendChild(el);

    clearTimeout(toastTimeout);
    toastTimeout = setTimeout(() => {
      el.classList.remove("show");
      setTimeout(() => el.remove(), 300);
    }, 3000);
  }

  // ============================================================
  // Rendering
  // ============================================================
  function renderAll() {
    renderOverall();
    renderBranches();
    updateModePill();
  }

  function renderOverall() {
    const o = STATE.overall;
    const badge = $("overallBadge");
    const badge2 = $("overallBadge2");
    const headline = $("overallHeadline");
    const notes = $("overallNotes");
    const summary = $("overallSummary");
    const updated = $("updatedAt");

    if (badge) badge.textContent = o.badge || "-";
    if (badge2) badge2.textContent = o.badge || "-";
    if (headline) headline.textContent = o.headline || "-";
    if (notes) notes.textContent = o.notes || "-";
    if (summary) summary.textContent = o.summary || "";
    if (updated) {
      try {
        const d = new Date(STATE.updatedAt);
        updated.textContent = d.toLocaleString();
      } catch {
        updated.textContent = STATE.updatedAt || "-";
      }
    }
  }

  function renderBranches() {
    const container = $("branches");
    if (!container) return;
    
    const keys = Object.keys(STATE.branches).sort();
    if (keys.length === 0) {
      container.innerHTML = '<p style="color:var(--muted)">No branches yet. Add some via Import or Edit.</p>';
      return;
    }

    container.innerHTML = keys.map(key => {
      const b = STATE.branches[key];
      const ckpts = (b.checkpoints || []).map(c => `<li>${esc(c)}</li>`).join("");
      return `
        <div class="tr" style="grid-template-columns:1.2fr 1fr 110px 80px;margin-bottom:12px">
          <div class="area">${esc(key)}</div>
          <div class="status">${esc(b.status || "Planned")}</div>
          <div class="bar"><i style="width:${b.progress || 0}%"></i></div>
          <button class="btn small" data-edit-branch="${esc(key)}">Edit</button>
        </div>
        ${ckpts ? `<ul class="ckpts">${ckpts}</ul>` : ""}
      `;
    }).join("");
  }

  function updateModePill() {
    const pill = $("localModePill");
    if (!pill) return;
    const cfg = getServerSettings();
    if (cfg.saveUrl) {
      pill.innerHTML = `Mode: <b>Local + Server</b>`;
    } else {
      pill.innerHTML = `Mode: <b>Local</b>`;
    }
  }

  // ============================================================
  // Overlays
  // ============================================================
  function openOverlay(id) {
    const el = $(id);
    if (el) el.classList.add("show");
  }

  function closeOverlay(id) {
    const el = $(id);
    if (el) el.classList.remove("show");
  }

  // ============================================================
  // Editing: Overall
  // ============================================================
  function openOverallEditor() {
    $("oBadge").value = STATE.overall.badge || "";
    $("oHeadline").value = STATE.overall.headline || "";
    $("oNotes").value = STATE.overall.notes || "";
    $("oSummary").value = STATE.overall.summary || "";
    $("oUpdatedAt").value = STATE.updatedAt || new Date().toISOString();
    openOverlay("ovOverall");
  }

  function saveOverallFromEditor() {
    STATE.overall.badge = ($("oBadge").value || "").trim();
    STATE.overall.headline = ($("oHeadline").value || "").trim();
    STATE.overall.notes = ($("oNotes").value || "").trim();
    STATE.overall.summary = ($("oSummary").value || "").trim();
    const customTime = ($("oUpdatedAt").value || "").trim();
    STATE.updatedAt = customTime || new Date().toISOString();
    saveLocal(STATE);
    renderAll();
    closeOverlay("ovOverall");
    toast("Overall saved locally");
  }

  // ============================================================
  // Editing: Branch
  // ============================================================
  function getBranchKeys() {
    return Object.keys(STATE.branches || {}).sort((a, b) => a.localeCompare(b));
  }

  function fillBranchSelect(selected) {
    const sel = $("bKey");
    if (!sel) return;
    const keys = getBranchKeys();
    sel.innerHTML = keys.map(k => `<option value="${esc(k)}">${esc(k)}</option>`).join("");
    if (selected && keys.includes(selected)) sel.value = selected;
  }

  function openBranchEditor(key) {
    fillBranchSelect(key);
    const k = $("bKey").value;
    const b = STATE.branches[k] || { status: "Planned", progress: 0, checkpoints: [] };
    $("bStatus").value = b.status || "Planned";
    $("bProgress").value = String(b.progress ?? 0);
    $("bCkpts").value = (b.checkpoints || []).join("\n");
    openOverlay("ovBranch");
  }

  function saveBranchFromEditor() {
    const key = ($("bKey").value || "").trim();
    if (!key) {
      toast("Missing branch key");
      return;
    }
    if (!STATE.branches[key]) {
      STATE.branches[key] = { status: "Planned", progress: 0, checkpoints: [] };
    }

    STATE.branches[key].status = ($("bStatus").value || "").trim();
    STATE.branches[key].progress = clamp(Number($("bProgress").value || 0) || 0, 0, 100);
    STATE.branches[key].checkpoints = normalizeCheckpoints(($("bCkpts").value || "").trim());

    STATE.updatedAt = new Date().toISOString();
    saveLocal(STATE);
    renderAll();
    closeOverlay("ovBranch");
    toast("Branch saved locally");
  }

  // ============================================================
  // Import / Export
  // ============================================================
  function exportJson() {
    const json = JSON.stringify(STATE, null, 2);
    const blob = new Blob([json], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "status.json";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    setTimeout(() => URL.revokeObjectURL(url), 100);
    toast("Exported status.json");
  }

  function openImport() {
    $("importJson").value = "";
    openOverlay("ovImport");
  }

  function applyImport() {
    const text = ($("importJson").value || "").trim();
    if (!text) {
      toast("No JSON to import");
      return;
    }
    try {
      const parsed = JSON.parse(text);
      STATE = normalizeState(parsed);
      STATE.updatedAt = new Date().toISOString();
      saveLocal(STATE);
      renderAll();
      closeOverlay("ovImport");
      toast("Imported successfully");
    } catch (e) {
      toast("Invalid JSON: " + e.message);
    }
  }

  function openExport() {
    $("exportJsonText").value = JSON.stringify(STATE, null, 2);
    openOverlay("ovExport");
  }

  function copyExport() {
    const text = $("exportJsonText").value;
    navigator.clipboard.writeText(text).then(() => {
      toast("Copied to clipboard");
    }).catch(() => {
      toast("Copy failed - select and copy manually");
    });
  }

  function openExportTab() {
    const json = JSON.stringify(STATE, null, 2);
    const blob = new Blob([json], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    window.open(url, "_blank");
    setTimeout(() => URL.revokeObjectURL(url), 1000);
  }

  // ============================================================
  // Server sync
  // ============================================================
  async function saveToServer() {
    const cfg = getServerSettings();
    if (!cfg.saveUrl) {
      toast("Set Save URL first");
      openServerSettings();
      return;
    }
    if (!cfg.apiKey) {
      toast("Set API key first");
      openServerSettings();
      return;
    }

    STATE.updatedAt = new Date().toISOString();

    const payload = {
      updated_by: cfg.updatedBy || "dashboard",
      status: STATE
    };

    try {
      const res = await fetch(cfg.saveUrl, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "x-api-key": cfg.apiKey
        },
        body: JSON.stringify(payload)
      });

      if (!res.ok) {
        const txt = await res.text().catch(() => "");
        throw new Error(`HTTP ${res.status} ${res.statusText}${txt ? " – " + txt : ""}`);
      }

      const data = await res.json().catch(() => ({}));
      if (data && data.status) {
        STATE = normalizeState(data.status);
        saveLocal(STATE);
        renderAll();
        toast("Saved to server");
      } else {
        saveLocal(STATE);
        renderAll();
        toast("Saved (no status returned)");
      }
    } catch (e) {
      toast("Save failed: " + e.message);
    }
  }

  async function refreshFromServer() {
    const cfg = getServerSettings();
    if (!cfg.readUrl) {
      toast("No Read URL configured");
      openServerSettings();
      return;
    }
    try {
      const res = await fetch(cfg.readUrl, {
        method: "GET",
        headers: cfg.apiKey ? { "x-api-key": cfg.apiKey } : {}
      });
      if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
      const data = await res.json();
      STATE = normalizeState(data);
      saveLocal(STATE);
      renderAll();
      toast("Refreshed from server");
    } catch (e) {
      toast("Refresh failed: " + e.message);
    }
  }

  function openServerSettings() {
    const cfg = getServerSettings();
    $("svSaveUrl").value = cfg.saveUrl;
    $("svReadUrl").value = cfg.readUrl;
    $("svApiKey").value = cfg.apiKey;
    $("svUpdatedBy").value = cfg.updatedBy || "dashboard";
    openOverlay("ovServer");
  }

  function saveServerSettingsFromModal() {
    setServerSettings({
      saveUrl: $("svSaveUrl").value,
      readUrl: $("svReadUrl").value,
      apiKey: $("svApiKey").value,
      updatedBy: $("svUpdatedBy").value
    });
    closeOverlay("ovServer");
    updateModePill();
    toast("Server settings saved");
  }

  function resetLocal() {
    if (!confirm("Reset all local data? This cannot be undone.")) return;
    try {
      localStorage.removeItem(STORAGE_KEY);
      STATE = {
        overall: {
          badge: "On Track",
          headline: "All systems operational",
          notes: "No blocking issues",
          summary: ""
        },
        branches: {},
        updatedAt: new Date().toISOString()
      };
      renderAll();
      toast("Local data reset");
    } catch (e) {
      toast("Reset failed: " + e.message);
    }
  }

  // ============================================================
  // Wire up UI
  // ============================================================
  function bind() {
    $("btnEditOverall")?.addEventListener("click", openOverallEditor);
    $("btnEditBranch")?.addEventListener("click", () => {
      const keys = getBranchKeys();
      if (keys.length === 0) {
        toast("No branches yet. Import JSON first or add branches manually.");
        return;
      }
      openBranchEditor(keys[0]);
    });

    $("btnNewBranch")?.addEventListener("click", openNewBranch);
    $("nbClose")?.addEventListener("click", closeNewBranch);
    $("nbCancel")?.addEventListener("click", closeNewBranch);
    $("nbCreate")?.addEventListener("click", createBranchFromForm);
    $("nbKey")?.addEventListener("keydown", (e) => { if (e.key === "Enter") createBranchFromForm(); });
    $("nbProgress")?.addEventListener("keydown", (e) => { if (e.key === "Enter") createBranchFromForm(); });
    $("btnExport")?.addEventListener("click", openExport);
    $("btnImport")?.addEventListener("click", openImport);
    $("btnServerSettings")?.addEventListener("click", openServerSettings);
    $("btnSyncServer")?.addEventListener("click", saveToServer);
    $("btnRefreshServer")?.addEventListener("click", refreshFromServer);
    $("btnResetLocal")?.addEventListener("click", resetLocal);

    // Overall modal
    $("saveOverall")?.addEventListener("click", saveOverallFromEditor);
    document.querySelectorAll('[data-close="ovOverall"]').forEach(btn => {
      btn.addEventListener("click", () => closeOverlay("ovOverall"));
    });

    // Branch modal
    $("saveBranch")?.addEventListener("click", saveBranchFromEditor);
    $("bKey")?.addEventListener("change", () => {
      const key = $("bKey").value;
      if (key) openBranchEditor(key);
    });
    document.querySelectorAll('[data-close="ovBranch"]').forEach(btn => {
      btn.addEventListener("click", () => closeOverlay("ovBranch"));
    });

    // Import modal
    $("applyImport")?.addEventListener("click", applyImport);
    document.querySelectorAll('[data-close="ovImport"]').forEach(btn => {
      btn.addEventListener("click", () => closeOverlay("ovImport"));
    });

    // Export modal
    $("copyExport")?.addEventListener("click", copyExport);
    $("openExportTab")?.addEventListener("click", openExportTab);
    document.querySelectorAll('[data-close="ovExport"]').forEach(btn => {
      btn.addEventListener("click", () => closeOverlay("ovExport"));
    });

    // Server modal
    $("btnCloseServer")?.addEventListener("click", () => closeOverlay("ovServer"));
    $("btnCancelServer")?.addEventListener("click", () => closeOverlay("ovServer"));
    $("btnSaveServerSettings")?.addEventListener("click", saveServerSettingsFromModal);

    // Click edit on branch cards (event delegation)
    $("branches")?.addEventListener("click", (e) => {
      const btn = e.target.closest("[data-edit-branch]");
      if (!btn) return;
      const key = btn.getAttribute("data-edit-branch");
      openBranchEditor(key);
    });

    // About button
    $("btnAbout")?.addEventListener("click", () => {
      const el = $("howItWorks");
      if (el) {
        el.style.display = el.style.display === "none" ? "block" : "none";
      }
    });
  }

  // ============================================================
  // Init
  // ============================================================
  function init() {
    const saved = loadLocal();
    if (saved) {
      STATE = normalizeState(saved);
    }
    bind();
    renderAll();
  }

  init();
})();
</script>
</body>
</html>