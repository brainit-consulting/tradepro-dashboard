<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TradeProBuddy - Interactive Project Dashboard</title>
  <meta name="color-scheme" content="dark light" />
  <meta http-equiv="Cache-Control" content="no-store, no-cache, must-revalidate, max-age=0" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <style>
    :root{
      --bg:#0b1220;
      --card:#0f1b33;
      --card2:#0b1428;
      --ink:#e5e7eb;
      --muted:#9aa7bd;
      --line:rgba(148,163,184,.18);
      --accent:#34d399;
      --accent2:#7b3fa0;
      --danger:#ef4444;
      --warn:#f59e0b;
      --ok:#22c55e;
      --shadow:0 18px 55px rgba(0,0,0,.45);
      --r:18px;
      --r2:14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background:radial-gradient(1200px 900px at 15% 0%, rgba(123,63,160,.22), transparent 50%),
                 radial-gradient(1100px 800px at 90% 0%, rgba(52,211,153,.16), transparent 55%),
                 linear-gradient(180deg, #070b15 0%, var(--bg) 100%);
      color:var(--ink);
      min-height:100vh;
    }
    a{color:inherit}
    .wrap{max-width:1180px;margin:0 auto;padding:26px 16px 42px}
    header{
      display:flex;gap:14px;align-items:flex-start;justify-content:space-between;
      padding:18px 18px 16px;border:1px solid var(--line);border-radius:var(--r);
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      box-shadow:var(--shadow);
      position:relative;
      overflow:hidden;
    }
    header:before{
      content:"";
      position:absolute;inset:-1px;
      background:radial-gradient(800px 260px at 25% 0%, rgba(52,211,153,.12), transparent 55%),
                 radial-gradient(700px 240px at 80% 0%, rgba(123,63,160,.16), transparent 60%);
      pointer-events:none;
    }
    header > *{position:relative;z-index:1}
    .h-title{margin:0;font-size:1.25rem;letter-spacing:.2px}
    .h-sub{
      margin:6px 0 0;
      color:var(--muted);
      max-width:none;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      display: block;
      min-width: 0;
    }

    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 12px;border-radius:999px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.18);
      color:var(--ink);
      font-size:.9rem;
      white-space:nowrap;
    }
    .pill b{font-weight:650}
    .badge{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 12px;border-radius:999px;
      border:1px solid var(--line);
      background:rgba(123,63,160,.12);
      color:var(--ink);
      font-size:.9rem;      
    }
    .build-version{
      margin-left:8px;
      font-size:0.85rem;
      color:var(--accent);
      font-weight:650;
      white-space:nowrap;
    }
    .dot{
      width:10px;height:10px;border-radius:50%;
      background:var(--accent);
      box-shadow:0 0 0 3px rgba(52,211,153,.12);
      flex:0 0 auto;
    }
    .toolbar{
      display:flex;flex-wrap:wrap;gap:10px;
      margin:14px 0 0;
    }
    .dropdown{position:relative}
    .dropdown-menu{
      position:absolute;
      right:0;
      top:calc(100% + 8px);
      min-width:220px;
      padding:8px;
      border:1px solid var(--line);
      border-radius:14px;
      background:rgba(2,6,23,.95);
      box-shadow:var(--shadow);
      display:none;
      flex-direction:column;
      gap:6px;
      z-index:50;
    }
    .dropdown.open .dropdown-menu{display:flex}
    .dropdown-menu .btn{
      width:100%;
      justify-content:space-between;
      font-size:.9rem;
    }
    .btn{
      appearance:none;border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      color:var(--ink);
      padding:10px 12px;border-radius:14px;
      cursor:pointer;
      display:inline-flex;align-items:center;gap:8px;
      font-weight:600;
      transition:transform .08s ease, background .15s ease, border-color .15s ease;
      user-select:none;
      pointer-events:auto;
    }
    .btn:hover{background:rgba(255,255,255,.06);border-color:rgba(148,163,184,.28)}
    .btn:active{transform:translateY(1px)}
    .btn.primary{
      border-color:rgba(52,211,153,.38);
      background:linear-gradient(180deg, rgba(52,211,153,.18), rgba(52,211,153,.08));
    }
    .btn.danger{
      border-color:rgba(239,68,68,.35);
      background:linear-gradient(180deg, rgba(239,68,68,.18), rgba(239,68,68,.08));
    }
    .btn.ghost{
      background:rgba(0,0,0,.18);
      border-color:rgba(148,163,184,.22);
    }
    .btn.ghost:hover{background:rgba(0,0,0,.28)}
    .btn.small{padding:8px 10px;border-radius:12px;font-weight:650}
    .grid{
      display:grid;gap:14px;margin-top:16px;
      grid-template-columns:repeat(12,1fr);
    }
    .card{
      grid-column:span 12;
      border:1px solid var(--line);
      border-radius:var(--r);
      background:linear-gradient(180deg, rgba(255,255,255,.035), rgba(255,255,255,.018));
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 16px;border-bottom:1px solid var(--line);
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      background:rgba(0,0,0,.15);
    }
    .card .hd h2{margin:0;font-size:1rem}
    .card .bd{padding:14px 16px}
    .kpis{
      display:grid;gap:12px;margin-top:12px;
      grid-template-columns:repeat(12,1fr);
    }
    .kpi{
      grid-column:span 12;
      border:1px solid var(--line);
      border-radius:var(--r2);
      background:rgba(0,0,0,.16);
      padding:12px 12px 11px;
    }
    .kpi .label{color:var(--muted);font-size:.85rem;margin:0 0 6px}
    .kpi .value{margin:0;font-size:1.05rem;font-weight:700;line-height:1.2}
    .kpi .sub{margin:6px 0 0;color:var(--muted);font-size:.9rem;line-height:1.35}
    .filters{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin:4px 0 12px;
    }
    .filters .field{
      min-width:160px;
      flex:1 1 180px;
    }
    .filters .field label{margin-bottom:4px}
    .filters .field input,
    .filters .field select{
      padding:8px 10px;
      border-radius:12px;
      font-size:.9rem;
    }
    .filter-actions{
      display:flex;
      align-items:flex-end;
    }
    .branch-meta{
      margin:6px 0 0;
      color:var(--muted);
      font-size:.85rem;
      line-height:1.35;
    }
    .chart-card{
      margin-bottom:12px;
      padding:12px;
      border:1px solid var(--line);
      border-radius:14px;
      background:rgba(0,0,0,.18);
    }
    .chart-title{
      color:var(--muted);
      font-size:.85rem;
      margin:0 0 8px;
      letter-spacing:.2px;
    }
    .chart-row{
      display:flex;
      align-items:center;
      gap:10px;
      margin:6px 0;
    }
    .chart-label{
      width:70px;
      color:var(--muted);
      font-size:.82rem;
    }
    .chart-bar{
      flex:1;
      height:10px;
      border-radius:999px;
      background:rgba(148,163,184,.12);
      border:1px solid rgba(148,163,184,.14);
      overflow:hidden;
    }
    .chart-bar i{
      display:block;
      height:100%;
      width:0%;
      background:linear-gradient(90deg, rgba(52,211,153,.7), rgba(123,63,160,.7));
    }
    .chart-count{
      width:30px;
      text-align:right;
      color:var(--muted);
      font-size:.82rem;
    }
    #overallNotes{white-space:pre-line}
    @media(min-width:860px){
      .kpi{grid-column:span 4}
    }
    .tr{
      display:grid;
      grid-template-columns: 32px 44px 1.2fr 1fr 110px 80px;
      gap:12px;
      padding:12px 12px;
      align-items:center;
      border:1px solid var(--line);
      border-radius:14px;
      background:rgba(0,0,0,.16);
    }
    .branch-item{margin-bottom:12px}
    .branch-item:last-child{margin-bottom:0}
    .area{font-weight:750}
    .status{
      color:var(--muted);
      font-weight:650;
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }
    .risk-badge{
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.22);
      background:rgba(0,0,0,.2);
      font-size:.72rem;
      font-weight:700;
      letter-spacing:.2px;
    }
    .risk-badge.overdue{
      border-color:rgba(239,68,68,.4);
      background:rgba(239,68,68,.12);
      color:#fecaca;
    }
    .risk-badge.risk{
      border-color:rgba(245,158,11,.4);
      background:rgba(245,158,11,.12);
      color:#fde68a;
    }
    .bar{
      height:12px;border-radius:999px;
      background:rgba(148,163,184,.12);
      border:1px solid rgba(148,163,184,.14);
      overflow:hidden;
    }
    .bar > i{
      display:block;height:100%;
      width:0%;
      background:linear-gradient(90deg, rgba(52,211,153,.75), rgba(123,63,160,.70));
    }
    .drag-handle{
      width:24px;height:24px;border-radius:8px;
      display:inline-flex;align-items:center;justify-content:center;
      border:1px solid rgba(148,163,184,.22);
      background:rgba(0,0,0,.2);
      color:var(--muted);
      cursor:grab;
      user-select:none;
    }
    .drag-handle:active{cursor:grabbing}
    .move-controls{
      display:flex;
      flex-direction:column;
      gap:6px;
      align-items:center;
    }
    .move-btn{
      width:28px;
      height:28px;
      padding:0;
      border-radius:10px;
      font-size:12px;
      line-height:1;
    }
    .move-btn:disabled{
      opacity:.4;
      cursor:not-allowed;
    }
    .branch-item.drag-over .tr{
      border-color:rgba(52,211,153,.5);
      background:rgba(52,211,153,.08);
    }
    .branch-item.dragging{opacity:.6}
    .ckpts{
      margin:10px 0 0;
      padding:0 0 0 18px;
      color:var(--muted);
      line-height:1.45;
    }
    .ckpts li{margin:4px 0}
    .foot{
      margin-top:14px;
      color:var(--muted);
      font-size:.9rem;
      line-height:1.45;
    }

    /* Modal */
    .overlay{
      position:fixed;inset:0;
      background:rgba(0,0,0,.55);
      backdrop-filter: blur(10px) saturate(140%);
      display:none;
      align-items:center;justify-content:center;
      padding:26px 14px;
      z-index:1000;
      pointer-events:auto;
    }
    .overlay.show{display:flex}
    .modal{
      width:min(980px, 96vw);
      border:1px solid rgba(148,163,184,.22);
      border-radius:22px;
      background:linear-gradient(180deg, rgba(255,255,255,.055), rgba(255,255,255,.025));
      box-shadow:0 28px 80px rgba(0,0,0,.6);
      overflow:hidden;
    }
    
    .modalHeader, .modalBody, .modalFooter{
      padding-left: 24px;
      padding-right: 24px;
    }
    .modalHeader{padding-top:22px; padding-bottom:14px;}
    .modalBody{padding-top:16px; padding-bottom:16px;}
    .modalFooter{padding-top:16px; padding-bottom:22px;}
    .modalClose{ top: 16px; right: 16px; }
.modal .mh{
      display:flex;align-items:flex-start;justify-content:space-between;gap:14px;
      padding:16px 16px;border-bottom:1px solid rgba(148,163,184,.18);
      background:rgba(0,0,0,.18);
    }
    .modal .mh h3{margin:0;font-size:1.05rem}
    .modal .mh p{margin:6px 0 0;color:var(--muted);max-width:72ch}
    .x{
      appearance:none;border:1px solid rgba(148,163,184,.22);
      background:rgba(0,0,0,.25);
      color:var(--ink);
      width:40px;height:40px;border-radius:14px;
      cursor:pointer;
      font-size:18px;font-weight:800;
    }
    .x:hover{background:rgba(0,0,0,.35)}
    .modal .mb{padding:16px}
    .form{
      display:grid;
      grid-template-columns:1fr;
      gap:12px;
    }
    @media(min-width:860px){ .form.two{grid-template-columns:1fr 1fr} }
    label{display:block;font-size:.85rem;color:var(--muted);margin:0 0 6px}
    input, textarea, select{
      width:100%;
      padding:11px 12px;
      border-radius:14px;
      border:1px solid rgba(148,163,184,.20);
      background:rgba(0,0,0,.25);
      color:var(--ink);
      outline:none;
    }
    textarea{min-height:150px;resize:vertical;line-height:1.4}
    input:focus, textarea:focus, select:focus{border-color:rgba(52,211,153,.45)}
    .actions{
      display:flex;gap:10px;flex-wrap:wrap;
      justify-content:flex-end;
      padding:14px 16px;
      border-top:1px solid rgba(148,163,184,.18);
      background:rgba(0,0,0,.14);
    }
    .toast{
      position:fixed;
      right:12px;bottom:12px;
      max-width:min(520px, calc(100vw - 24px));
      padding:12px 12px;
      border-radius:16px;
      border:1px solid rgba(148,163,184,.22);
      background:rgba(2,6,23,.92);
      color:var(--ink);
      box-shadow:0 20px 60px rgba(0,0,0,.55);
      display:none;
      z-index:2000;
    }
    .toast.show{display:block}
    .toast .t{font-weight:750}
    .toast .m{margin-top:6px;color:var(--muted);line-height:1.35}

    /* Passcode gate */
    #gate{
      position:fixed;inset:0;
      z-index:3000;
      display:flex;
      align-items:center;justify-content:center;
      padding:34px 14px;
      background:radial-gradient(900px 600px at 20% 0%, rgba(123,63,160,.25), transparent 58%),
                 radial-gradient(900px 600px at 85% 0%, rgba(52,211,153,.18), transparent 60%),
                 rgba(2,6,23,.92);
      backdrop-filter: blur(12px) saturate(160%);
      pointer-events:auto;
    }
    .gate-card{
      width:min(560px, 96vw);
      border:1px solid rgba(148,163,184,.22);
      border-radius:22px;
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow:0 30px 90px rgba(0,0,0,.65);
      overflow:hidden;
    }
    .gate-card .top{padding:16px 16px;border-bottom:1px solid rgba(148,163,184,.18)}
    .gate-card h2{margin:0;font-size:1.1rem}
    .gate-card p{margin:8px 0 0;color:var(--muted);line-height:1.4}
    .gate-card .mid{padding:16px}
    .gate-row{display:flex;gap:10px;align-items:center}
    .gate-row input{flex:1}
    .err{margin-top:10px;color:#fecaca;display:none}
    .err.show{display:block}
    .hint{margin-top:12px;color:var(--muted);font-size:.9rem}
  
    .modalHeader{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:14px;
      padding-top:22px;
      padding-bottom:14px;
      border-bottom:1px solid rgba(148,163,184,.18);
      background:rgba(0,0,0,.18);
      position:relative;
    }
    .modalTitle{
      font-size:1.05rem;
      font-weight:750;
      margin:0;
    }
    .modalSub{
      margin-top:6px;
      color:var(--muted);
      max-width:72ch;
      line-height:1.35;
      font-size:.95rem;
    }
    .iconBtn{
      appearance:none;
      border:1px solid rgba(148,163,184,.22);
      background:rgba(0,0,0,.25);
      color:var(--ink);
      width:40px;height:40px;
      border-radius:14px;
      cursor:pointer;
      font-size:18px;
      font-weight:800;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      flex:0 0 auto;
    }
    .iconBtn:hover{background:rgba(0,0,0,.35)}
    .grid2{
      display:grid;
      grid-template-columns:1fr;
      gap:12px;
    }
    @media(min-width:860px){
      .grid2{grid-template-columns:1fr 1fr;}
    }
    .field{display:block}
    .help{margin-top:6px;color:var(--muted);font-size:.85rem;line-height:1.35}
    .modalFooter{
      display:flex;
      justify-content:flex-end;
      gap:10px;
      flex-wrap:wrap;
      padding-top:16px;
      padding-bottom:22px;
      border-top:1px solid rgba(148,163,184,.18);
      background:rgba(0,0,0,.14);
    }

  
    .brand-logo{
      width:96px;
      height:96px;
      border-radius:16px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.18);
      display:flex;
      align-items:center;
      justify-content:center;
      flex:0 0 auto;
      align-self:center;
      overflow:hidden;
    }
    .brand-logo img{
      width:82%;
      height:82%;
      object-fit:contain;
      display:block;
    }
@keyframes spin{to{transform:rotate(360deg)}}

    #savePill{gap:8px}
    #savePill .dot{width:10px;height:10px;border-radius:999px;display:inline-block;background:rgba(255,255,255,.35)}
    #savePill[data-state="ok"] .dot{background:rgba(76,175,80,.95)}
    #savePill[data-state="warn"] .dot{background:rgba(255,193,7,.95)}
    #savePill[data-state="err"] .dot{background:rgba(244,67,54,.95)}

</style>
</head>

<body>
  <div id="gate" aria-modal="true" role="dialog">
    <div class="gate-card">
      <div class="top">
        <h2>TradeProBuddy Dashboard</h2>
        <p><span class="dot"></span> Protected view</p>
      </div>
      <div class="mid">
        <label for="gateCode">Enter passcode</label>
        <div class="gate-row">
          <input id="gateCode" type="password" autocomplete="current-password" placeholder="Passcode" />
          <button id="gateBtn" class="btn primary" type="button">Unlock</button>
        </div>
        <div id="gateErr" class="err">Incorrect passcode. Try again.</div>
        <div class="hint">Tip: this is only front-end protection. For real security, serve behind authentication.</div>
      </div>
    </div>
  </div>

  <div class="wrap" id="app">
    <header>
      <div style="min-width: 0;">
        <h1 class="h-title">TradeProBuddy™ Project Dashboard</h1>
        <p class="h-sub">Server-backed view + editable data (saved to your server).<span class="build-version">• Build: V044</span></p>
        <div style="display:flex;flex-wrap:wrap;gap:10px;margin-top:12px">
          <span class="pill"><span class="dot"></span><b>Owner:</b> Emile (BrainIT Consulting)</span>
          <span class="pill" title="Stored as ISO UTC in status.json; displayed here in your local time zone."><b>Updated:</b> <span id="updatedAt">-</span></span>
            <span class="pill" id="savePill" title="Last successful server save / load"><span class="dot" id="saveDot"></span><b id="saveLabel">Server</b>: <span id="saveRev">rev -</span></span>
        </div>
      </div>
      <div class="brand-logo">
        <img src="https://img1.wsimg.com/isteam/ip/deac7fcc-497b-4e83-8280-f4ec9c3eb3ce/BrainITBrain1.png/:/rs=w:200,h:200,cg:true,m/cr=w:200,h:200/qt=q:95" alt="BrainIT Consulting logo" />
      </div>      <div style="display:flex;flex-direction:column;align-items:flex-end;gap:10px">
        <span class="badge"><span class="dot"></span><span id="overallBadge">-</span></span>
        <button class="btn small" type="button" id="btnAbout">How this works</button>
      </div>
    </header>

    <div class="toolbar" aria-label="Dashboard actions">
      <button class="btn primary" type="button" id="btnEditOverall">Edit Overall</button>
      <button class="btn" type="button" id="btnEditBranch">Edit a Branch</button>
      <button class="btn" type="button" id="btnNewBranch">New Branch</button>
      <button class="btn" type="button" id="btnServerSettings">Server Settings</button>
      <button class="btn" type="button" id="btnSyncServer">Save To Server</button>
      <button class="btn ghost" type="button" id="btnRefreshServer">Refresh from Server</button>
      <div class="dropdown" id="backupsDropdown">
        <button class="btn ghost" type="button" id="btnBackups" aria-haspopup="true" aria-expanded="false">Backups ⬇️</button>
        <div class="dropdown-menu" id="backupsMenu" role="menu">
          <button class="btn ghost small" type="button" id="btnDashboardBackup">Dashboard backup</button>
          <button class="btn ghost small" type="button" id="btnDashboardRestore">Restore/import</button>
        </div>
      </div>
    </div>
    <input id="dashboardImportFile" type="file" accept="application/json" style="display:none" />

    <div class="foot" id="howItWorks" style="display:none">
      <b>How this works:</b> This dashboard is <b>server-first</b>. Use <b>Refresh from Server</b> to pull the latest saved data from your server, make edits, then click <b>Save To Server</b>. Your <b>Server Settings</b> are stored locally and are never cleared by this dashboard.
    </div>

    <div class="grid">
      <section class="card" aria-labelledby="overallTitle">
        <div class="hd">
          <h2 id="overallTitle">Overall Status</h2>
          <span class="pill" id="overallSummaryPill" style="display:none"></span>
        </div>
        <div class="bd">
          <div class="kpis">
            <div class="kpi">
              <p class="label">Headline</p>
              <p class="value" id="overallHeadline">-</p>
            </div>
            <div class="kpi">
              <p class="label">Notes</p>
              <p class="value" style="font-size:1rem;font-weight:650" id="overallNotes">-</p>
            </div>
            <div class="kpi">
              <p class="label">Rolling Forward</p>
              <p class="value" id="overallBadge2">-</p>
              <p class="sub" style="margin-top:10px" id="overallProgress">Overall progress: -</p>
              <p class="sub" id="overallSummary">-</p>
            </div>
          </div>
        </div>
      </section>

      <section class="card" aria-labelledby="branchesTitle">
        <div class="hd">
          <h2 id="branchesTitle">Progress by Branch</h2>
          <span class="pill" id="localModePill">Mode: <b>Local</b></span>
        </div>
        <div class="bd">
          <div class="filters" id="branchFilters">
            <div class="field">
              <label for="filterSearch">Search</label>
              <input id="filterSearch" placeholder="Search branches, tags, owners" />
            </div>
            <div class="field">
              <label for="filterStatus">Status</label>
              <select id="filterStatus">
                <option value="">All</option>
                <option>Planned</option>
                <option>In Progress</option>
                <option>Active</option>
                <option>Paused</option>
                <option>In Development</option>
                <option>Blocked</option>
                <option>Done</option>
              </select>
            </div>
            <div class="field">
              <label for="filterPriority">Priority</label>
              <select id="filterPriority">
                <option value="">All</option>
                <option>Low</option>
                <option>Normal</option>
                <option>High</option>
                <option>Critical</option>
              </select>
            </div>
            <div class="field">
              <label for="filterOwner">Owner</label>
              <select id="filterOwner">
                <option value="">All</option>
              </select>
            </div>
            <div class="field">
              <label for="filterTag">Tag</label>
              <select id="filterTag">
                <option value="">All</option>
              </select>
            </div>
            <div class="filter-actions">
              <button class="btn ghost small" type="button" id="filterClear">Clear</button>
            </div>
          </div>

          <div class="chart-card" id="progressChartCard">
            <p class="chart-title">Progress Snapshot</p>
            <div id="progressChart"></div>
          </div>

          <div id="branches"></div>
        </div>
      </section>
    </div>

    <div class="foot">© 2025 BrainIT Consulting • TradeProBuddy™ Internal Dashboard</div>
  </div>

  <!-- MODALS -->
  <div class="overlay" id="ovOverall" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="mh">
        <div>
          <h3>Edit Overall</h3>
          <p>Saves locally. Use Save To Server to persist.</p>
        </div>
        <button class="x" type="button" data-close="ovOverall">x</button>
      </div>
      <div class="mb">
        <div class="form two">
          <div>
            <label for="oBadge">Badge</label>
            <input id="oBadge" />
          </div>
          <div>
            <label for="oUpdatedAt">Updated At (ISO)</label>
            <input id="oUpdatedAt" />
          </div>
          <div style="grid-column:1/-1">
            <label for="oHeadline">Headline</label>
            <input id="oHeadline" />
          </div>
          <div style="grid-column:1/-1">
            <label for="oNotes">Notes</label>
            <textarea id="oNotes"></textarea>
          </div>
          <div style="grid-column:1/-1">
            <label for="oSummary">Optional Summary (right-card pill)</label>
            <input id="oSummary" />
          </div>
        </div>
      </div>
      <div class="actions">
        <button class="btn primary" type="button" id="saveOverall">Save</button>
        <button class="btn" type="button" data-close="ovOverall">Cancel</button>
      </div>
    </div>
  </div>

  <div class="overlay" id="ovBranch" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="mh">
        <div>
          <h3>Edit Branch</h3>
          <p>Edit status / progress / checkpoints. Use one item per line.</p>
        </div>
        <button class="x" type="button" data-close="ovBranch">x</button>
      </div>
      <div class="mb">
        <div class="form two">
          <div>
            <label for="bKey">Branch</label>
            <select id="bKey"></select>
          </div>
          <div>
            <label for="bRename">Rename to</label>
            <input id="bRename" placeholder="Leave blank to keep current" />
            <div class="help">Letters/numbers plus dashes and underscores only.</div>
          </div>
          <div>
            <label for="bStatus">Status</label>
            <select id="bStatus">
              <option>Planned</option>
              <option>In Progress</option>
              <option>Active</option>
              <option>Paused</option>
              <option>In Development</option>
              <option>Blocked</option>
              <option>Done</option>
            </select>
          </div>
          <div>
            <label for="bPriority">Priority</label>
            <select id="bPriority">
              <option>Low</option>
              <option>Normal</option>
              <option>High</option>
              <option>Critical</option>
            </select>
          </div>
          <div>
            <label for="bOwner">Owner</label>
            <input id="bOwner" placeholder="Owner name" />
          </div>
          <div>
            <label for="bDueDate">Due Date</label>
            <input id="bDueDate" type="date" />
          </div>
          <div style="grid-column:1/-1">
            <label for="bProgress">Progress (0-100)</label>
            <input id="bProgress" type="number" min="0" max="100" step="1" />
          </div>
          <div style="grid-column:1/-1">
            <label for="bTags">Tags (comma separated)</label>
            <input id="bTags" placeholder="ops, qa, crm" />
          </div>
          <div style="grid-column:1/-1">
            <label for="bCkpts">Checkpoints (one per line)</label>
            <textarea id="bCkpts"></textarea>
          </div>
        </div>
      </div>
      <div class="actions">
        <button class="btn primary" type="button" id="saveBranch">Save</button>
        <button class="btn" type="button" data-close="ovBranch">Cancel</button>
      </div>
    </div>
  </div>
<div class="overlay" id="ovServer">
    <div class="modal">
      <div class="mh">
        <div>
          <h3>Server settings</h3>
          <p>Configure n8n webhook endpoints and API key.</p>
        </div>
        <button class="x" type="button" id="btnCloseServer">×</button>
      </div>

      <div class="mb">
        <div class="form two">
          <div style="grid-column:1/-1">
            <label for="svSaveUrl">Save URL (POST)</label>
            <input id="svSaveUrl" placeholder="https://YOUR-N8N/webhook/..." />
            <p class="hint">This is your n8n webhook URL for saving status.</p>
          </div>

          <div style="grid-column:1/-1">
            <label for="svReadUrl">Read URL (GET)</label>
            <input id="svReadUrl" placeholder="https://YOUR-N8N/webhook/read" />
            <p class="hint">Used by Refresh and auto-load to fetch the latest saved status.</p>
          </div>

          <div style="grid-column:1/-1">
            <label for="svApiKey">API key header (x-api-key)</label>
            <input id="svApiKey" placeholder="tpb_..." />
            <p class="hint">Must match your Header Auth credential in n8n.</p>
          </div>

          <div style="grid-column:1/-1">
            <label for="svUpdatedBy">Updated by</label>
            <input id="svUpdatedBy" placeholder="dashboard" />
            <p class="hint">Saved with each revision for auditing.</p>
          </div>
        </div>

        <div class="foot" style="margin-top:16px;padding:12px;background:rgba(52,211,153,.08);border:1px solid rgba(52,211,153,.22);border-radius:12px">
          <b style="color:var(--accent)">Tip:</b> Click "Refresh from Server" after saving settings to test the connection.
        </div>
      </div>

      <div class="actions">
        <button class="btn" id="btnCancelServer" type="button">Cancel</button>
        <button class="btn ghost" id="btnImportServerSettings" type="button">Import settings</button>
        <button class="btn ghost" id="btnBackupServerSettings" type="button">Backup settings</button>
        <button class="btn ghost" id="btnTestServerSettings" type="button">Test connection</button>
        <button class="btn primary" id="btnSaveServerSettings" type="button">Save settings</button>
      </div>
      <input id="svImportFile" type="file" accept="application/json" style="display:none" />
    </div>
  </div>



  <div class="overlay" id="ovBackupSettings" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="mh">
        <div>
          <h3>Backup Server Settings</h3>
          <p>Download or copy a JSON backup of your server settings.</p>
        </div>
        <button class="x" type="button" data-close="ovBackupSettings">x</button>
      </div>
      <div class="mb">
        <div class="form">
          <div>
            <label for="backupSettingsText">Backup JSON</label>
            <textarea id="backupSettingsText" readonly style="min-height:220px;font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;"></textarea>
            <div class="help">If the download is blocked, copy this JSON and save it as a .json file.</div>
          </div>
        </div>
      </div>
      <div class="actions">
        <button class="btn" type="button" id="btnBackupCopy">Copy JSON</button>
        <button class="btn primary" type="button" data-close="ovBackupSettings">Close</button>
      </div>
    </div>
  </div>

  <div class="overlay" id="ovDashboardBackup" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="mh">
        <div>
          <h3>Dashboard Backup</h3>
          <p>Download or copy a JSON backup of your dashboard data (server settings excluded).</p>
        </div>
        <button class="x" type="button" data-close="ovDashboardBackup">x</button>
      </div>
      <div class="mb">
        <div class="form">
          <div>
            <label for="dashboardBackupText">Backup JSON</label>
            <textarea id="dashboardBackupText" readonly style="min-height:220px;font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;"></textarea>
            <div class="help">If the download is blocked, copy this JSON and save it as a .json file.</div>
          </div>
        </div>
      </div>
      <div class="actions">
        <button class="btn" type="button" id="btnDashboardBackupCopy">Copy JSON</button>
        <button class="btn primary" type="button" data-close="ovDashboardBackup">Close</button>
      </div>
    </div>
  </div>

  <div class="overlay" id="ovDashboardRestoreConfirm" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="mh">
        <div>
          <h3>Restore Dashboard Backup</h3>
          <p>This will replace your local dashboard data with the selected backup.</p>
        </div>
        <button class="x" type="button" data-close="ovDashboardRestoreConfirm">x</button>
      </div>
      <div class="mb">
        <div class="form">
          <div>
            <label>Restore summary</label>
            <div class="help" id="dashboardRestoreSummary">Backup details will appear here.</div>
          </div>
        </div>
      </div>
      <div class="actions">
        <button class="btn" type="button" id="btnDashboardRestoreCancel">Cancel</button>
        <button class="btn primary" type="button" id="btnDashboardRestoreConfirm">Restore</button>
      </div>
    </div>
  </div>

  <!-- New Branch Overlay -->
  <div class="overlay" id="ovNewBranch" aria-hidden="true">
    <div class="modal">
      <div class="modalHeader">
        <div>
          <div class="modalTitle">Create New Branch</div>
          <div class="modalSub">Adds a new branch card and saves locally. Use "Save To Server" to persist to n8n.</div>
        </div>
        <button class="iconBtn" type="button" id="nbClose" aria-label="Close">✕</button>
      </div>

      <div class="modalBody">
        <div class="grid2">
          <div class="field">
            <label>Branch Key (unique)</label>
            <input id="nbKey" placeholder="e.g. qa, hubspot, crm" />
            <div class="help">Letters/numbers plus dashes and underscores only.</div>
          </div>

          <div class="field">
            <label>Status</label>
            <select id="nbStatus">
              <option>Planned</option>
              <option>In Progress</option>
              <option>In Review</option>
              <option>Blocked</option>
              <option>Active</option>
              <option>Done</option>
            </select>
          </div>

          <div class="field">
            <label>Progress (0—100)</label>
            <input id="nbProgress" type="number" min="0" max="100" step="1" value="0" />
          </div>

          <div class="field" style="grid-column:1/-1;">
            <label>Checkpoints (one per line)</label>
            <textarea id="nbCheckpoints" rows="6" placeholder="First checkpoint&#10;Second checkpoint"></textarea>
          </div>
        </div>
      </div>

      <div class="modalFooter">
        <button class="btn ghost" type="button" id="nbCancel">Cancel</button>
        <button class="btn primary" type="button" id="nbCreate">Create Branch</button>
      </div>
    </div>
  </div>


<script>
(() => {
  "use strict";

  const $ = (id) => document.getElementById(id);

  const STORAGE_KEY = "tpb_status_v1";
  const META_KEY = "tpb_branch_meta_v1";
  const DEFAULT_OWNER = "Emile";
  const RISK_DAYS = 7;
  const RISK_PROGRESS = 50;
  const SERVER_META = { revision: null, updated_at: null, updated_by: null, state: 'warn', label: 'Server' };
  let HAS_REFRESHED = false;
  
  let DIRTY = false;
  let SAVE_IN_FLIGHT = false;
  let AUTOSAVE_TIMER = null;
  let AUTOSAVE_INTERVAL = null;
  let LAST_REMOTE_CHECK_AT = 0;
  let DRAG_KEY = null;
  let PENDING_RESTORE = null;

  function markDirty() {
    DIRTY = true;
    // show unsaved state in the server pill
    SERVER_META.state = "warn";
    SERVER_META.label = "Unsaved";
    updateSavePill();
    requestAutosave("edit");
  }

  function clearDirty() {
    DIRTY = false;
    // leave label alone if it already says Saved ✓
    if (SERVER_META.label === "Unsaved") {
      SERVER_META.label = "Server";
    }
    updateSavePill();
    if (SERVER_META.revision == null) refreshServerMetaOnly();
  }

  function normalizePayload(payload) {
    if (Array.isArray(payload)) return payload[0] || {};
    return payload || {};
  }

  function normalizeRevision(value) {
    if (typeof value === "number" && Number.isFinite(value)) return value;
    const str = String(value ?? "").trim();
    if (/^\d+$/.test(str)) return Number.parseInt(str, 10);
    return null;
  }

  function extractServerMeta(payload) {
    const root = normalizePayload(payload);
    const rootJson = root && typeof root.json === "object" ? root.json : null;
    const status = root && typeof root.status === "object" ? root.status : null;
    const meta = root && typeof root.meta === "object" ? root.meta : null;
    const statusMeta = status && typeof status.meta === "object" ? status.meta : null;
    const item0 = Array.isArray(root.items) ? root.items[0] : null;
    const itemJson = item0 && typeof item0.json === "object" ? item0.json : null;
    const itemStatus = item0 && typeof item0.status === "object" ? item0.status : null;
    const itemMeta = item0 && typeof item0.meta === "object" ? item0.meta : null;
    const itemJsonStatus = itemJson && typeof itemJson.status === "object" ? itemJson.status : null;
    const itemJsonMeta = itemJson && typeof itemJson.meta === "object" ? itemJson.meta : null;
    const rawRevision =
      root.revision ??
      root.rev ??
      rootJson?.revision ??
      rootJson?.rev ??
      status?.revision ??
      status?.rev ??
      meta?.revision ??
      meta?.rev ??
      statusMeta?.revision ??
      statusMeta?.rev ??
      item0?.revision ??
      item0?.rev ??
      itemJson?.revision ??
      itemJson?.rev ??
      itemStatus?.revision ??
      itemStatus?.rev ??
      itemMeta?.revision ??
      itemMeta?.rev ??
      itemJsonStatus?.revision ??
      itemJsonStatus?.rev ??
      itemJsonMeta?.revision ??
      itemJsonMeta?.rev ??
      null;
    return {
      revision: normalizeRevision(rawRevision),
      updated_at:
        root.updated_at ??
        rootJson?.updated_at ??
        status?.updated_at ??
        meta?.updated_at ??
        statusMeta?.updated_at ??
        item0?.updated_at ??
        itemJson?.updated_at ??
        itemStatus?.updated_at ??
        itemMeta?.updated_at ??
        itemJsonStatus?.updated_at ??
        itemJsonMeta?.updated_at ??
        null,
      updated_by:
        root.updated_by ??
        rootJson?.updated_by ??
        status?.updated_by ??
        meta?.updated_by ??
        statusMeta?.updated_by ??
        item0?.updated_by ??
        itemJson?.updated_by ??
        itemStatus?.updated_by ??
        itemMeta?.updated_by ??
        itemJsonStatus?.updated_by ??
        itemJsonMeta?.updated_by ??
        null
    };
  }

  async function refreshServerMetaOnly() {
    const cfg = getServerSettings();
    if (!cfg.readUrl) return;
    try {
      const res = await fetch(cfg.readUrl, {
        method: "GET",
        headers: {
          "Accept": "application/json",
          ...(cfg.apiKey ? { "x-api-key": cfg.apiKey } : {})
        }
      });
      if (!res.ok) return;
      const data = await res.json().catch(() => ({}));
      const meta = extractServerMeta(data);
      if (meta.revision != null) SERVER_META.revision = meta.revision;
      if (meta.updated_at != null) SERVER_META.updated_at = meta.updated_at;
      if (meta.updated_by != null) SERVER_META.updated_by = meta.updated_by;
      updateSavePill();
    } catch {
      // ignore meta refresh failures
    }
  }

  function requestAutosave(source) {
    const cfg = getServerSettings();
    if (!cfg.saveUrl || !cfg.apiKey) return;
    if (SAVE_IN_FLIGHT) return;

    if (AUTOSAVE_TIMER) clearTimeout(AUTOSAVE_TIMER);
    AUTOSAVE_TIMER = setTimeout(async () => {
      if (!DIRTY) return;
      await autosaveToServer();
    }, 1400);
  }

  async function autosaveToServer() {
    const cfg = getServerSettings();
    if (!cfg.saveUrl || !cfg.apiKey) return;
    if (SAVE_IN_FLIGHT) return;
    try {
      SERVER_META.state = "warn";
      SERVER_META.label = "Saving…";
      updateSavePill();
      await saveToServer({ isAuto: true });
    } catch (e) {
      // saveToServer already toasts on failure
    }
  }

  async function remoteHasNewerRevision() {
    const cfg = getServerSettings();
    if (!cfg.readUrl || !cfg.apiKey) return false;

    const now = Date.now();
    if (now - LAST_REMOTE_CHECK_AT < 15000) return false; // throttle
    LAST_REMOTE_CHECK_AT = now;

    try {
      const res = await fetch(cfg.readUrl, {
        method: "GET",
        headers: { "x-api-key": cfg.apiKey }
      });
      const dataRaw = await res.json().catch(() => ({}));
      const meta = extractServerMeta(dataRaw);
      const remoteRev = meta.revision ?? null;

      if (remoteRev != null && SERVER_META.revision != null && remoteRev > SERVER_META.revision) {
        toast("Server has a newer revision (rev " + remoteRev + "). Refresh first to avoid overwrite.", "warn");
        return true;
      }
    } catch (e) {
      // ignore remote check failures
    }
    return false;
  }

const PASS_KEY = "tpb_gate_ok_v1";

  const SV_SAVE_URL_KEY = "tpb_sv_save_url_v1";
  const SV_READ_URL_KEY = "tpb_sv_read_url_v1";
  const SV_API_KEY_KEY  = "tpb_sv_api_key_v1";
  const SV_UPDATED_BY_KEY = "tpb_sv_updated_by_v1";

  const PASSCODE = "tradepro";

  let STATE = {
    overall: {
      badge: "On Track",
      headline: "All systems operational",
      notes: "No blocking issues",
      summary: ""
    },
    branches: {},
    branchOrder: [],
    updatedAt: new Date().toISOString()
  };

  let META = { meta: {} };

  function saveLocal(data) {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    } catch (e) {
      console.error("Failed to save to localStorage:", e);
    }
  }

  function loadMeta() {
    try {
      const raw = localStorage.getItem(META_KEY);
      if (raw) {
        const parsed = JSON.parse(raw);
        if (parsed && typeof parsed === "object") {
          const meta = parsed.meta && typeof parsed.meta === "object" ? parsed.meta : {};
          return { meta };
        }
      }
    } catch (e) {
      console.error("Failed to load metadata:", e);
    }
    return { meta: {} };
  }

  function saveMeta() {
    try {
      localStorage.setItem(META_KEY, JSON.stringify(META));
    } catch (e) {
      console.error("Failed to save metadata:", e);
    }
  }

  function normalizeTags(text) {
    return String(text || "")
      .split(",")
      .map(s => s.trim())
      .filter(Boolean);
  }

  function parseDueDate(value) {
    const raw = String(value || "").trim();
    if (!raw) return null;
    const d = new Date(raw + "T00:00:00");
    if (Number.isNaN(d.getTime())) return null;
    return d;
  }

  function getRiskStatus(meta, branch) {
    const due = parseDueDate(meta.dueDate);
    if (!due) return { overdue: false, atRisk: false, daysLeft: null };
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    const dueDay = new Date(due);
    dueDay.setHours(0, 0, 0, 0);
    const daysLeft = Math.round((dueDay - today) / 86400000);
    const progress = clamp(Number(branch?.progress ?? 0) || 0, 0, 100);
    const overdue = daysLeft < 0;
    const atRisk = !overdue && daysLeft <= RISK_DAYS && progress < RISK_PROGRESS;
    return { overdue, atRisk, daysLeft };
  }

  function getBranchMeta(key) {
    const meta = META.meta && META.meta[key] ? META.meta[key] : {};
    const tags = Array.isArray(meta.tags) ? meta.tags : normalizeTags(meta.tags || "");
    return {
      owner: meta.owner || DEFAULT_OWNER,
      tags,
      dueDate: meta.dueDate || "",
      priority: meta.priority || (STATE.branches[key] && STATE.branches[key].priority) || "Normal"
    };
  }

  function setBranchMeta(key, data) {
    if (!META.meta) META.meta = {};
    const existing = META.meta[key] && typeof META.meta[key] === "object" ? META.meta[key] : {};
    META.meta[key] = { ...existing, ...data };
    saveMeta();
  }

  function renameBranchMeta(oldKey, newKey) {
    if (!META.meta || !META.meta[oldKey]) return;
    META.meta[newKey] = META.meta[oldKey];
    delete META.meta[oldKey];
    saveMeta();
  }

  function persistLocal(){
    saveLocal(STATE);
  }

  function openNewBranch(ev) {
    try { ev?.preventDefault?.(); } catch {}
    const ov = $("ovNewBranch");
    if (!ov) return;
    $("nbKey").value = "";
    $("nbStatus").value = "Planned";
    $("nbProgress").value = 0;
    $("nbCheckpoints").value = "";
    ov.classList.add("show");
    ov.setAttribute("aria-hidden", "false");
    setTimeout(() => $("nbKey")?.focus?.(), 50);
  }

  function closeNewBranch(ev) {
    try { ev?.preventDefault?.(); ev?.stopPropagation?.(); } catch {}
    const ov = $("ovNewBranch");
    if (!ov) return;
    ov.classList.remove("show");
    ov.setAttribute("aria-hidden", "true");
  }

  function sanitizeBranchKey(raw) {
    const s = String(raw || "").trim();
    return s.toLowerCase()
      .replace(/[^a-z0-9_-]+/g, "-")
      .replace(/^-+/, "")
      .replace(/-+$/, "");
  }

  function splitLinesToArray(text) {
    return String(text || "")
      .split("\n")
      .map(s => s.trim())
      .filter(Boolean);
  }

  function createBranchFromForm(ev){
    try { ev?.preventDefault?.(); } catch {}
    const rawKey = ($("nbKey")?.value || "").trim();
    const key = sanitizeBranchKey(rawKey);
    const status = ($("nbStatus")?.value || "Planned").trim() || "Planned";
    const progress = clampInt(($("nbProgress")?.value ?? "0"), 0, 100);
    const checkpoints = splitLinesToArray($("nbCheckpoints")?.value || "");

    if (!key){
      toast("Please enter a branch key (letters/numbers/dashes/underscores).", "warn");
      try { $("nbKey")?.focus?.(); } catch {}
      return;
    }

    STATE.branches = STATE.branches && typeof STATE.branches === "object" ? STATE.branches : {};
    if (STATE.branches[key]){
      toast(`Branch "${key}" already exists. Pick a different key.`, "warn");
      try { $("nbKey")?.focus?.(); } catch {}
      return;
    }

    STATE.branches[key] = { status, priority: "Normal", progress, checkpoints };
    setBranchMeta(key, { owner: DEFAULT_OWNER, tags: [], dueDate: "", priority: "Normal" });
    STATE.branchOrder = normalizeBranchOrder(STATE.branches, STATE.branchOrder);
    STATE.updatedAt = new Date().toISOString();

    persistLocal();
    try { renderAll(); markDirty();
    } catch {}
    closeNewBranch();
    toast(`Created branch: ${key}`, "ok");
  }

  window.TPB_UI = {
    openNewBranch,
    closeNewBranch,
    createBranchFromForm,
  };

  function loadLocal() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw) return JSON.parse(raw);
    } catch (e) {
      console.error("Failed to load from localStorage:", e);
    }
    return null;
  }

  function getServerSettings() {
    try {
      return {
        saveUrl: localStorage.getItem(SV_SAVE_URL_KEY) || "",
        readUrl: localStorage.getItem(SV_READ_URL_KEY) || "",
        apiKey: localStorage.getItem(SV_API_KEY_KEY) || "",
        updatedBy: localStorage.getItem(SV_UPDATED_BY_KEY) || "dashboard"
      };
    } catch {
      return { saveUrl: "", readUrl: "", apiKey: "", updatedBy: "dashboard" };
    }
  }

  function setServerSettings(cfg) {
    try {
      localStorage.setItem(SV_SAVE_URL_KEY, cfg.saveUrl || "");
      localStorage.setItem(SV_READ_URL_KEY, cfg.readUrl || "");
      localStorage.setItem(SV_API_KEY_KEY, cfg.apiKey || "");
      localStorage.setItem(SV_UPDATED_BY_KEY, cfg.updatedBy || "dashboard");
    } catch (e) {
      console.error("Failed to save server settings:", e);
    }
  }

  const gateOverlay = $("gate");
  const gateInput   = $("gateCode");
  const gateBtn     = $("gateBtn");
  const gateErr     = $("gateErr");

  function setGateError(msg) {
    if (!gateErr) return;
    gateErr.textContent = msg || "";
    gateErr.style.display = msg ? "block" : "none";
  }

  function lockApp() {
    try { localStorage.removeItem(PASS_KEY); } catch {}
    if (gateOverlay) gateOverlay.style.display = "flex";
    setGateError("");
    if (gateInput) gateInput.value = "";
    setTimeout(() => gateInput?.focus(), 0);
  }

  function unlockApp() {
    try { localStorage.setItem(PASS_KEY, "1"); } catch {}
    if (gateOverlay) gateOverlay.style.display = "none";
    setGateError("");
    renderAll();
    toast("Unlocked successfully");
  }

  function attemptUnlock() {
    const v = (gateInput?.value || "").trim();
    if (!v) {
      setGateError("Enter passcode.");
      gateInput?.focus();
      return;
    }
    if (v === PASSCODE) {
      unlockApp();
      return;
    }
    setGateError("Incorrect passcode.");
    gateInput?.select();
  }

  if (gateBtn) gateBtn.addEventListener("click", (e) => { e.preventDefault(); attemptUnlock(); });
  if (gateInput) gateInput.addEventListener("keydown", (e) => { if (e.key === "Enter") { e.preventDefault(); attemptUnlock(); } });

  try {
    const ok = localStorage.getItem(PASS_KEY);
    if (ok === "1") unlockApp(); else lockApp();
  } catch {
    lockApp();
  }

  function esc(str) {
    const div = document.createElement("div");
    div.textContent = str;
    return div.innerHTML;
  }

  function clamp(val, min, max) {
    return Math.max(min, Math.min(max, val));
  }

  function clampInt(val, min, max) {
    const n = parseInt(val, 10);
    return clamp(Number.isFinite(n) ? n : 0, min, max);
  }

  function normalizeCheckpoints(text) {
    return text.split("\n").map(s => s.trim()).filter(Boolean);
  }

  function normalizeBranchOrder(branches, order) {
    const keys = Object.keys(branches || {});
    const list = Array.isArray(order) ? order.filter(k => keys.includes(k)) : [];
    keys.forEach(k => { if (!list.includes(k)) list.push(k); });
    return list;
  }

  function normalizeState(raw) {
    const safe = raw || {};
    const branches = safe.branches && typeof safe.branches === "object" ? safe.branches : {};
    return {
      overall: safe.overall || STATE.overall,
      branches,
      branchOrder: normalizeBranchOrder(branches, safe.branchOrder),
      updatedAt: safe.updatedAt || new Date().toISOString()
    };
  }

  let toastTimeout;
  
  function setLoading(isLoading, label) {
    const el = document.getElementById("loadingOverlay");
    const txt = document.getElementById("loadingText");
    if (!el || !txt) return;
    if (isLoading) {
      txt.textContent = label || "Loading…";
      el.style.display = "flex";
    } else {
      el.style.display = "none";
    }
  }

function toast(msg, kind, opts) {
    const options = opts || {};
    const duration = Number.isFinite(options.duration) ? options.duration : 4000;

    document.querySelectorAll(".toast").forEach(t => {
      t.classList.remove("show");
      setTimeout(() => t.remove(), 350);
    });

    const el = document.createElement("div");
    el.className = "toast show";
    const k = String(kind || "").toLowerCase();
    const tag = k ? ` <span style="color:${k==='ok'?'var(--ok)':k==='warn'?'var(--warn)':k==='err'||k==='danger'?'var(--danger)':'var(--accent)'};font-weight:800">•</span>` : "";
    el.innerHTML = `<div class="t">${esc(msg)}${tag}</div>`;
    document.body.appendChild(el);

    let timer = null;
    const start = () => {
      stop();
      timer = setTimeout(() => {
        el.classList.remove("show");
        setTimeout(() => el.remove(), 350);
      }, duration);
    };
    const stop = () => { if (timer) { clearTimeout(timer); timer = null; } };

    el.addEventListener("mouseenter", stop);
    el.addEventListener("mouseleave", start);

    start();
  }

  function renderAll() {
    renderOverall();
    renderBranches();
    updateModePill();
  }

  function renderOverall() {
    const o = STATE.overall;
    const badge = $("overallBadge");
    const badge2 = $("overallBadge2");
    const headline = $("overallHeadline");
    const notes = $("overallNotes");
    const summary = $("overallSummary");
    const summaryPill = $("overallSummaryPill");
    const progressEl = $("overallProgress");
    const updated = $("updatedAt");

    if (badge) badge.textContent = o.badge || "-";
    if (badge2) badge2.textContent = o.badge || "-";
    if (headline) headline.textContent = o.headline || "-";
    if (notes) notes.textContent = o.notes || "-";
    if (summary) summary.textContent = o.summary || "";
    if (summaryPill) {
      const text = (o.summary || "").trim();
      if (text) {
        summaryPill.textContent = text;
        summaryPill.style.display = "inline-flex";
      } else {
        summaryPill.textContent = "";
        summaryPill.style.display = "none";
      }
    }
    if (progressEl) {
      const branches = Object.values(STATE.branches || {});
      if (!branches.length) {
        progressEl.textContent = "Overall progress: -";
      } else {
        const total = branches.reduce((sum, b) => {
          const val = clamp(Number(b?.progress ?? 0) || 0, 0, 100);
          return sum + val;
        }, 0);
        const avg = Math.round(total / branches.length);
        progressEl.textContent = `Overall progress: ${avg}%`;
      }
    }
    if (updated) {
      try {
        const d = new Date(STATE.updatedAt);
        updated.textContent = d.toLocaleString();
      } catch {
        updated.textContent = STATE.updatedAt || "-";
      }
    }
  }

  function getFilterValues() {
    return {
      search: ($("filterSearch")?.value || "").trim().toLowerCase(),
      status: ($("filterStatus")?.value || "").trim(),
      priority: ($("filterPriority")?.value || "").trim(),
      owner: ($("filterOwner")?.value || "").trim(),
      tag: ($("filterTag")?.value || "").trim()
    };
  }

  function setSelectOptions(select, values) {
    if (!select) return;
    const current = select.value || "";
    const options = ['<option value="">All</option>']
      .concat(values.map(v => `<option value="${esc(v)}">${esc(v)}</option>`));
    select.innerHTML = options.join("");
    select.value = values.includes(current) ? current : "";
  }

  function buildFilterOptions(keys) {
    const owners = new Set();
    const tags = new Set();
    keys.forEach(key => {
      const meta = getBranchMeta(key);
      owners.add(meta.owner || DEFAULT_OWNER);
      (meta.tags || []).forEach(t => tags.add(t));
    });
    setSelectOptions($("filterOwner"), Array.from(owners).sort((a, b) => a.localeCompare(b)));
    setSelectOptions($("filterTag"), Array.from(tags).sort((a, b) => a.localeCompare(b)));
  }

  function clearFilters() {
    const ids = ["filterSearch", "filterStatus", "filterPriority", "filterOwner", "filterTag"];
    ids.forEach(id => {
      const el = $(id);
      if (!el) return;
      if (el.tagName === "SELECT") {
        el.value = "";
      } else {
        el.value = "";
      }
    });
    renderBranches();
  }

  function branchMatchesFilters(key, branch, meta, filters) {
    const status = branch.status || "Planned";
    if (filters.status && status !== filters.status) return false;
    if (filters.priority && meta.priority !== filters.priority) return false;
    if (filters.owner && meta.owner !== filters.owner) return false;
    if (filters.tag) {
      const tagLower = filters.tag.toLowerCase();
      const tagsLower = (meta.tags || []).map(t => t.toLowerCase());
      if (!tagsLower.includes(tagLower)) return false;
    }
    if (filters.search) {
      const hay = [
        key,
        status,
        meta.owner,
        meta.priority,
        meta.dueDate,
        (meta.tags || []).join(" "),
        (branch.checkpoints || []).join(" ")
      ].join(" ").toLowerCase();
      if (!hay.includes(filters.search)) return false;
    }
    return true;
  }

  function getVisibleBranchKeys(keys) {
    const filters = getFilterValues();
    return keys.filter(key => {
      const b = STATE.branches[key] || {};
      const meta = getBranchMeta(key);
      return branchMatchesFilters(key, b, meta, filters);
    });
  }

  function renderProgressChart(keys) {
    const el = $("progressChart");
    if (!el) return;
    if (!keys.length) {
      el.innerHTML = '<p style="margin:0;color:var(--muted)">No branches to chart.</p>';
      return;
    }
    const buckets = [0, 0, 0, 0];
    keys.forEach(key => {
      const b = STATE.branches[key] || {};
      const p = clamp(Number(b.progress || 0) || 0, 0, 100);
      const idx = p <= 25 ? 0 : p <= 50 ? 1 : p <= 75 ? 2 : 3;
      buckets[idx] += 1;
    });
    const max = Math.max(...buckets, 1);
    const labels = ["0-25", "26-50", "51-75", "76-100"];
    const colors = ["#ef4444", "#f59e0b", "#facc15", "#22c55e"];
    el.innerHTML = labels.map((label, i) => {
      const width = Math.round((buckets[i] / max) * 100);
      return `
        <div class="chart-row">
          <div class="chart-label">${label}%</div>
          <div class="chart-bar"><i style="width:${width}%;background:${colors[i]}"></i></div>
          <div class="chart-count">${buckets[i]}</div>
        </div>
      `;
    }).join("");
  }

  function renderBranches() {
    const container = $("branches");
    if (!container) return;
    
    const keys = getOrderedBranchKeys();
    if (keys.length === 0) {
      container.innerHTML = '<p style="color:var(--muted)">No branches yet. Click "New Branch" to add one.</p>';
      renderProgressChart([]);
      return;
    }

    buildFilterOptions(keys);
    const visibleKeys = getVisibleBranchKeys(keys);

    if (visibleKeys.length === 0) {
      container.innerHTML = '<p style="color:var(--muted)">No matching branches. Clear filters to see all.</p>';
      renderProgressChart([]);
      return;
    }

    container.innerHTML = visibleKeys.map((key, idx) => {
      const b = STATE.branches[key];
      const meta = getBranchMeta(key);
      const ownerText = esc(meta.owner || DEFAULT_OWNER);
      const priorityText = esc(meta.priority || "Normal");
      const dueText = meta.dueDate ? esc(meta.dueDate) : "-";
      const tagsText = (meta.tags && meta.tags.length) ? meta.tags.map(t => esc(t)).join(", ") : "-";
      const risk = getRiskStatus(meta, b);
      const riskBadge = risk.overdue
        ? `<span class="risk-badge overdue">Overdue</span>`
        : risk.atRisk
          ? `<span class="risk-badge risk">At Risk</span>`
          : "";
      const statusHtml = `<div class="status"><span>${esc(b.status || "Planned")}</span>${riskBadge}</div>`;
      const isFirst = idx === 0;
      const isLast = idx === visibleKeys.length - 1;
      const ckpts = (b.checkpoints || []).map(c => `<li>${esc(c)}</li>`).join("");
      return `
        <div class="branch-item" data-branch-key="${esc(key)}">
          <div class="tr">
            <span class="drag-handle" draggable="true" title="Drag to reorder" aria-label="Drag to reorder">::</span>
            <div class="move-controls">
              <button class="btn small move-btn" type="button" data-move-branch="up" data-branch-key="${esc(key)}" ${isFirst ? "disabled" : ""} aria-label="Move branch up">▲</button>
              <button class="btn small move-btn" type="button" data-move-branch="down" data-branch-key="${esc(key)}" ${isLast ? "disabled" : ""} aria-label="Move branch down">▼</button>
            </div>
            <div class="area">${esc(key)}</div>
            ${statusHtml}
            <div class="bar"><i style="width:${b.progress || 0}%"></i></div>
            <button class="btn small" data-edit-branch="${esc(key)}">Edit</button>
          </div>
          <div class="branch-meta">Owner: ${ownerText} | Priority: ${priorityText} | Due: ${dueText} | Tags: ${tagsText}</div>
          ${ckpts ? `<ul class="ckpts">${ckpts}</ul>` : ""}
        </div>
      `;
    }).join("");

    renderProgressChart(visibleKeys);
  }


  function reorderBranches(dragKey, targetKey, insertBefore) {
    const order = getOrderedBranchKeys().filter(k => k !== dragKey);
    const targetIndex = order.indexOf(targetKey);
    if (targetIndex === -1) return;
    const insertIndex = insertBefore ? targetIndex : targetIndex + 1;
    order.splice(insertIndex, 0, dragKey);
    STATE.branchOrder = order;
    STATE.updatedAt = new Date().toISOString();
    saveLocal(STATE);
    renderAll();
    markDirty();
  }

  function moveBranchInView(key, direction) {
    const order = getOrderedBranchKeys();
    const visible = getVisibleBranchKeys(order);
    const idx = visible.indexOf(key);
    if (idx === -1) return;
    const swapKey = direction === "up" ? visible[idx - 1] : visible[idx + 1];
    if (!swapKey) return;
    const orderIdx = order.indexOf(key);
    const swapIdx = order.indexOf(swapKey);
    if (orderIdx === -1 || swapIdx === -1) return;
    const tmp = order[orderIdx];
    order[orderIdx] = order[swapIdx];
    order[swapIdx] = tmp;
    STATE.branchOrder = order;
    STATE.updatedAt = new Date().toISOString();
    saveLocal(STATE);
    renderAll();
    markDirty();
  }

  function clearBranchDragState(container) {
    if (!container) return;
    container.querySelectorAll(".branch-item.drag-over").forEach(el => el.classList.remove("drag-over"));
    container.querySelectorAll(".branch-item.dragging").forEach(el => el.classList.remove("dragging"));
  }

  function updateModePill() {
    const pill = $("localModePill");
    if (!pill) return;
    const cfg = getServerSettings();
    if (cfg.saveUrl) {
      pill.innerHTML = `Mode: <b>Server-backed</b>`;
    } else {
      pill.innerHTML = `Mode: <b>Local</b>`;
    }
  }

  function updateSavePill() {
    const el = document.getElementById("savePill");
    const revEl = document.getElementById("saveRev");
    const labelEl = document.getElementById("saveLabel");
    if (!el || !revEl || !labelEl) return;

    const rev = (SERVER_META.revision ?? "-");
    revEl.textContent = "rev " + rev;
    labelEl.textContent = SERVER_META.label || "Server";
    el.dataset.state = SERVER_META.state || "warn";
  }

  function markServerLoaded(meta) {
    if (meta && meta.revision != null) SERVER_META.revision = meta.revision;
    if (meta && meta.updated_at != null) SERVER_META.updated_at = meta.updated_at;
    if (meta && meta.updated_by != null) SERVER_META.updated_by = meta.updated_by;
    SERVER_META.state = "ok";
    SERVER_META.label = "Server";
    HAS_REFRESHED = true;
    clearDirty();
    updateSavePill();
    if (SERVER_META.revision == null) refreshServerMetaOnly();
  }

  function markServerSaved(meta) {
    if (meta && meta.revision != null) SERVER_META.revision = meta.revision;
    if (meta && meta.updated_at != null) SERVER_META.updated_at = meta.updated_at;
    if (meta && meta.updated_by != null) SERVER_META.updated_by = meta.updated_by;
    SERVER_META.state = "ok";
    SERVER_META.label = "Saved ✓";
    clearDirty();
    updateSavePill();
  }

  function markServerError() {
    SERVER_META.state = "err";
    SERVER_META.label = "Server";
    updateSavePill();
  }

  function openOverlay(id) {
    const el = $(id);
    if (el) el.classList.add("show");
  }

  function closeOverlay(id) {
    const el = $(id);
    if (el) el.classList.remove("show");
  }

  function openOverallEditor() {
    $("oBadge").value = STATE.overall.badge || "";
    $("oHeadline").value = STATE.overall.headline || "";
    $("oNotes").value = STATE.overall.notes || "";
    $("oSummary").value = STATE.overall.summary || "";
    $("oUpdatedAt").value = STATE.updatedAt || new Date().toISOString();
    openOverlay("ovOverall");
  }

  function saveOverallFromEditor() {
    STATE.overall.badge = ($("oBadge").value || "").trim();
    STATE.overall.headline = ($("oHeadline").value || "").trim();
    STATE.overall.notes = ($("oNotes").value || "").trim();
    STATE.overall.summary = ($("oSummary").value || "").trim();
    const customTime = ($("oUpdatedAt").value || "").trim();
    STATE.updatedAt = customTime || new Date().toISOString();
    saveLocal(STATE);
    renderAll();
    markDirty();
    closeOverlay("ovOverall");
    toast("Overall saved locally");
  }

  function getBranchKeys() {
    return getOrderedBranchKeys();
  }

  function getOrderedBranchKeys() {
    return normalizeBranchOrder(STATE.branches, STATE.branchOrder);
  }

  function fillBranchSelect(selected) {
    const sel = $("bKey");
    if (!sel) return;
    const keys = getBranchKeys();
    sel.innerHTML = keys.map(k => `<option value="${esc(k)}">${esc(k)}</option>`).join("");
    if (selected && keys.includes(selected)) sel.value = selected;
  }

  function openBranchEditor(key) {
    fillBranchSelect(key);
    const k = $("bKey").value;
    const b = STATE.branches[k] || { status: "Planned", progress: 0, checkpoints: [] };
    const meta = getBranchMeta(k);
    $("bRename").value = k || "";
    $("bStatus").value = b.status || "Planned";
    $("bPriority").value = meta.priority || "Normal";
    $("bOwner").value = meta.owner || DEFAULT_OWNER;
    $("bDueDate").value = meta.dueDate || "";
    $("bTags").value = (meta.tags || []).join(", ");
    $("bProgress").value = String(b.progress ?? 0);
    $("bCkpts").value = (b.checkpoints || []).join("\n");
    openOverlay("ovBranch");
  }

  function saveBranchFromEditor() {
    const key = ($("bKey").value || "").trim();
    if (!key) {
      toast("Missing branch key");
      return;
    }
    const renameRaw = ($("bRename").value || "").trim();
    const nextKey = renameRaw ? sanitizeBranchKey(renameRaw) : key;
    if (!nextKey) {
      toast("Invalid branch key");
      return;
    }
    const owner = ($("bOwner").value || "").trim() || DEFAULT_OWNER;
    const tags = normalizeTags(($("bTags").value || "").trim());
    const dueDate = ($("bDueDate").value || "").trim();
    const priority = ($("bPriority").value || "Normal").trim() || "Normal";
    if (nextKey !== key && STATE.branches[nextKey]) {
      toast(`Branch "${nextKey}" already exists. Pick a different key.`, "warn");
      return;
    }
    if (!STATE.branches[key]) {
      STATE.branches[key] = { status: "Planned", progress: 0, checkpoints: [] };
    }
    if (nextKey !== key) {
      STATE.branches[nextKey] = STATE.branches[key];
      delete STATE.branches[key];
      if (Array.isArray(STATE.branchOrder)) {
        const idx = STATE.branchOrder.indexOf(key);
        if (idx !== -1) STATE.branchOrder[idx] = nextKey;
      }
      renameBranchMeta(key, nextKey);
    }

    STATE.branches[nextKey].status = ($("bStatus").value || "").trim();
    STATE.branches[nextKey].priority = priority;
    STATE.branches[nextKey].progress = clamp(Number($("bProgress").value || 0) || 0, 0, 100);
    STATE.branches[nextKey].checkpoints = normalizeCheckpoints(($("bCkpts").value || "").trim());
    setBranchMeta(nextKey, { owner, tags, dueDate, priority });
    STATE.branchOrder = normalizeBranchOrder(STATE.branches, STATE.branchOrder);

    STATE.updatedAt = new Date().toISOString();
    saveLocal(STATE);
    renderAll();
    markDirty();
    closeOverlay("ovBranch");
    toast("Branch saved locally");
  }

  async function saveToServer(opts = {}) {
    const cfg = getServerSettings();
    if (!cfg.saveUrl) { 
      toast("Set Save URL first", "warn"); 
      openServerSettings(); 
      return; 
    }
    if (!cfg.apiKey) { 
      toast("Set API key first", "warn"); 
      openServerSettings(); 
      return; 
    }
    if (!HAS_REFRESHED) {
      toast("Refresh from Server first to load latest data.", "warn");
    }
    // Prevent accidental overwrite if server advanced elsewhere (manual saves only)
    if (!opts.isAuto && DIRTY) {
      const newer = await remoteHasNewerRevision();
      if (newer) return;
    }

    SAVE_IN_FLIGHT = true;

    const localSnapshot = JSON.parse(JSON.stringify(STATE));
    STATE.updatedAt = new Date().toISOString();

    const payload = {
      updated_by: cfg.updatedBy || "dashboard",
      status: STATE
    };

    try {
      const res = await fetch(cfg.saveUrl, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "x-api-key": cfg.apiKey
        },
        body: JSON.stringify(payload)
      });

      if (!res.ok) {
        const txt = await res.text().catch(() => "");
        throw new Error(`HTTP ${res.status} ${res.statusText}${txt ? " – " + txt : ""}`);
      }

      const data = await res.json().catch(() => ({}));

      if (data && data.status && typeof data.status === "object") {
        const server = data.status || {};
        const merged = {
          ...localSnapshot,
          ...server,
          overall: { ...(localSnapshot.overall || {}), ...(server.overall || {}) },
          branches: { ...(localSnapshot.branches || {}), ...(server.branches || {}) },
          updatedAt: server.updatedAt || localSnapshot.updatedAt || new Date().toISOString()
        };

        STATE = normalizeState(merged);
        saveLocal(STATE);
        renderAll();
        markServerSaved(extractServerMeta(data));
        toast("Saved to server", "ok");
        return;
      }

      STATE = localSnapshot;
      saveLocal(STATE);
      renderAll();
      const meta = extractServerMeta(data);
      markServerSaved({
        revision: meta.revision ?? null,
        updated_by: meta.updated_by ?? payload.updated_by,
        updated_at: meta.updated_at ?? STATE.updatedAt
      });
      toast("Saved (no status returned)", "ok");

    } catch (e) {
      STATE = localSnapshot;
      saveLocal(STATE);
      renderAll();
      markServerError();
      toast("Save failed: " + e.message, "danger");
    } finally {
      SAVE_IN_FLIGHT = false;
    }
  }

  async function refreshFromServer() {
    const cfg = getServerSettings();
    if (!cfg.readUrl) { 
      toast("Set Read URL first", "warn"); 
      openServerSettings(); 
      return; 
    }

    const localSnapshot = JSON.parse(JSON.stringify(STATE));

    try {
      console.log("Fetching from:", cfg.readUrl);
      
      const res = await fetch(cfg.readUrl, {
        method: "GET",
        headers: {
          "Accept": "application/json",
          ...(cfg.apiKey ? { "x-api-key": cfg.apiKey } : {})
        }
      });

      if (!res.ok) {
        const txt = await res.text().catch(() => "");
        throw new Error(`HTTP ${res.status} ${res.statusText}${txt ? ": " + txt : ""}`);
      }

      const data = await res.json().catch(() => ({}));
      console.log("Server response:", data);

      // Try multiple response formats
      let serverStatus = null;
      
      if (data.status && typeof data.status === "object") {
        // Format: { status: { overall, branches, ... } }
        serverStatus = data.status;
      } else if (data.overall || data.branches) {
        // Format: { overall, branches, ... } (direct status object)
        serverStatus = data;
      }

      if (serverStatus) {
        STATE = normalizeState(serverStatus);
        saveLocal(STATE);
        renderAll();
        markServerLoaded(extractServerMeta(data));
        toast("Refreshed from server", "ok");
        return;
      }

      throw new Error("No valid status data in response");
    } catch (e) {
      console.error("Refresh error:", e);
      STATE = localSnapshot;
      saveLocal(STATE);
      renderAll();
      markServerError();
      toast("Refresh failed: " + e.message, "danger");
    }
  }

  function openServerSettings() {
    const cfg = getServerSettings();
    $("svSaveUrl").value = cfg.saveUrl;
    $("svReadUrl").value = cfg.readUrl;
    $("svApiKey").value = cfg.apiKey;
    $("svUpdatedBy").value = cfg.updatedBy || "dashboard";
    openOverlay("ovServer");
  }

  function saveServerSettingsFromModal() {
    const saveUrl = ($("svSaveUrl").value || "").trim();
    const readUrl = ($("svReadUrl").value || "").trim();
    const apiKey = ($("svApiKey").value || "").trim();
    const updatedBy = ($("svUpdatedBy").value || "").trim() || "dashboard";

    if (!saveUrl || !readUrl || !apiKey) {
      toast("Save URL, Read URL, and API key are required.", "warn");
      return;
    }

    setServerSettings({ saveUrl, readUrl, apiKey, updatedBy });
    closeOverlay("ovServer");
    updateModePill();
    toast("Server settings saved", "ok");
  }

  function startImportServerSettings() {
    const input = $("svImportFile");
    if (input) input.click();
  }

  async function importServerSettingsFromFile(ev) {
    const input = ev?.target;
    const file = input?.files?.[0];
    if (input) input.value = "";
    if (!file) return;

    let raw = "";
    try {
      raw = await file.text();
    } catch {
      toast("Could not read settings file.", "warn");
      return;
    }

    let data = null;
    try {
      data = JSON.parse(raw);
    } catch {
      toast("Invalid JSON in settings file.", "warn");
      return;
    }

    const saveUrl = String(data.saveUrl || data.save_url || "").trim();
    const readUrl = String(data.readUrl || data.read_url || "").trim();
    const apiKey = String(data.apiKey || data.api_key || "").trim();
    const updatedBy = String(data.updatedBy || data.updated_by || "dashboard").trim() || "dashboard";

    if (!saveUrl || !readUrl || !apiKey) {
      toast("Backup missing Save URL, Read URL, or API key.", "warn");
      return;
    }

    $("svSaveUrl").value = saveUrl;
    $("svReadUrl").value = readUrl;
    $("svApiKey").value = apiKey;
    $("svUpdatedBy").value = updatedBy;
    toast("Settings loaded. Click Save settings to apply.", "ok");
  }

  async function testServerConnection() {
    const stored = getServerSettings();
    const readUrl = ($("svReadUrl")?.value || stored.readUrl || "").trim();
    const apiKey = ($("svApiKey")?.value || stored.apiKey || "").trim();
    if (!readUrl) {
      toast("Set Read URL first", "warn");
      return;
    }

    const start = performance.now();
    try {
      const res = await fetch(readUrl, {
        method: "GET",
        headers: {
          "Accept": "application/json",
          ...(apiKey ? { "x-api-key": apiKey } : {})
        }
      });
      const ms = Math.round(performance.now() - start);
      if (!res.ok) {
        const txt = await res.text().catch(() => "");
        throw new Error(`HTTP ${res.status} ${res.statusText}${txt ? ": " + txt : ""}`);
      }
      const data = await res.json().catch(() => ({}));
      const meta = extractServerMeta(data);
      const revText = meta.revision != null ? `rev ${meta.revision}` : "rev -";
      toast(`Connection ok (${revText}, ${ms}ms)`, "ok");
    } catch (e) {
      toast("Connection failed: " + e.message, "danger");
    }
  }

  function openBackupModal(jsonText) {
    const box = $("backupSettingsText");
    if (box) box.value = jsonText || "";
    openOverlay("ovBackupSettings");
  }

  function copyBackupSettings() {
    const box = $("backupSettingsText");
    if (!box) return;
    const text = box.value || "";
    if (!text) {
      toast("Nothing to copy.", "warn");
      return;
    }

    const fallback = () => {
      box.focus();
      box.select();
      try {
        const ok = document.execCommand("copy");
        toast(ok ? "Backup copied to clipboard" : "Copy failed", ok ? "ok" : "warn");
      } catch {
        toast("Copy failed", "warn");
      }
    };

    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(text).then(
        () => toast("Backup copied to clipboard", "ok"),
        () => fallback()
      );
    } else {
      fallback();
    }
  }

  async function backupServerSettings() {
    const cfg = getServerSettings();
    if (!cfg.saveUrl || !cfg.readUrl || !cfg.apiKey) {
      toast("Save settings first to back them up.", "warn");
      return;
    }

    const payload = {
      saveUrl: cfg.saveUrl,
      readUrl: cfg.readUrl,
      apiKey: cfg.apiKey,
      updatedBy: cfg.updatedBy || "dashboard",
      exportedAt: new Date().toISOString()
    };

    const json = JSON.stringify(payload, null, 2);
    const stamp = new Date().toISOString().replace(/[:.]/g, "-");
    const filename = `tpb_server_settings_${stamp}.json`;

    if (window.showSaveFilePicker) {
      try {
        const handle = await window.showSaveFilePicker({
          suggestedName: filename,
          types: [{ description: "JSON", accept: { "application/json": [".json"] } }]
        });
        const writable = await handle.createWritable();
        await writable.write(json);
        await writable.close();
        toast("Server settings backup saved", "ok");
        return;
      } catch (e) {
        if (e && e.name === "AbortError") {
          toast("Backup canceled", "warn");
          return;
        }
      }
    }

    try {
      const blob = new Blob([json], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      setTimeout(() => {
        URL.revokeObjectURL(url);
        link.remove();
      }, 0);
    } catch {
      // ignore download failures
    }

    openBackupModal(json);
    toast("Download may be blocked. Use copy backup.", "warn");
  }

  function setBackupsMenu(isOpen) {
    const wrap = $("backupsDropdown");
    const btn = $("btnBackups");
    if (!wrap || !btn) return;
    wrap.classList.toggle("open", !!isOpen);
    btn.setAttribute("aria-expanded", isOpen ? "true" : "false");
  }

  function toggleBackupsMenu() {
    const wrap = $("backupsDropdown");
    if (!wrap) return;
    setBackupsMenu(!wrap.classList.contains("open"));
  }

  function openDashboardBackupModal(jsonText) {
    const box = $("dashboardBackupText");
    if (box) box.value = jsonText || "";
    openOverlay("ovDashboardBackup");
  }

  function copyDashboardBackup() {
    const box = $("dashboardBackupText");
    if (!box) return;
    const text = box.value || "";
    if (!text) {
      toast("Nothing to copy.", "warn");
      return;
    }

    const fallback = () => {
      box.focus();
      box.select();
      try {
        const ok = document.execCommand("copy");
        toast(ok ? "Backup copied to clipboard" : "Copy failed", ok ? "ok" : "warn");
      } catch {
        toast("Copy failed", "warn");
      }
    };

    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(text).then(
        () => toast("Backup copied to clipboard", "ok"),
        () => fallback()
      );
    } else {
      fallback();
    }
  }

  async function backupDashboardData() {
    const payload = {
      version: "V044",
      exportedAt: new Date().toISOString(),
      status: JSON.parse(JSON.stringify(STATE)),
      meta: (META && typeof META.meta === "object") ? META.meta : {}
    };

    const json = JSON.stringify(payload, null, 2);
    const stamp = new Date().toISOString().replace(/[:.]/g, "-");
    const filename = `tpb_dashboard_backup_${stamp}.json`;

    if (window.showSaveFilePicker) {
      try {
        const handle = await window.showSaveFilePicker({
          suggestedName: filename,
          types: [{ description: "JSON", accept: { "application/json": [".json"] } }]
        });
        const writable = await handle.createWritable();
        await writable.write(json);
        await writable.close();
        toast("Dashboard backup saved", "ok");
        return;
      } catch (e) {
        if (e && e.name === "AbortError") {
          toast("Backup canceled", "warn");
          return;
        }
      }
    }

    try {
      const blob = new Blob([json], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      setTimeout(() => {
        URL.revokeObjectURL(url);
        link.remove();
      }, 0);
    } catch {
      // ignore download failures
    }

    openDashboardBackupModal(json);
    toast("Download may be blocked. Use copy backup.", "warn");
  }

  function openDashboardRestoreConfirm(summary) {
    const el = $("dashboardRestoreSummary");
    if (el) el.textContent = summary || "Backup details unavailable.";
    openOverlay("ovDashboardRestoreConfirm");
  }

  function confirmDashboardRestore() {
    if (!PENDING_RESTORE) {
      closeOverlay("ovDashboardRestoreConfirm");
      return;
    }
    STATE = normalizeState(PENDING_RESTORE.status);
    META = { meta: PENDING_RESTORE.meta || {} };
    saveLocal(STATE);
    saveMeta();
    renderAll();
    markDirty();
    PENDING_RESTORE = null;
    closeOverlay("ovDashboardRestoreConfirm");
    toast("Dashboard restored from backup", "ok");
  }

  function cancelDashboardRestore() {
    PENDING_RESTORE = null;
    closeOverlay("ovDashboardRestoreConfirm");
  }

  function startDashboardRestore() {
    const input = $("dashboardImportFile");
    if (input) input.click();
  }

  async function restoreDashboardFromFile(ev) {
    const input = ev?.target;
    const file = input?.files?.[0];
    if (input) input.value = "";
    if (!file) return;

    let raw = "";
    try {
      raw = await file.text();
    } catch {
      toast("Could not read backup file.", "warn");
      return;
    }

    let data = null;
    try {
      data = JSON.parse(raw);
    } catch {
      toast("Invalid JSON in backup file.", "warn");
      return;
    }

    const status =
      (data && typeof data.status === "object" && data.status) ||
      (data && typeof data.state === "object" && data.state) ||
      ((data && (data.overall || data.branches)) ? data : null);
    if (!status) {
      toast("Backup missing status data.", "warn");
      return;
    }

    const metaRoot = (data && typeof data.meta === "object") ? data.meta : {};
    const meta = (metaRoot && typeof metaRoot.meta === "object") ? metaRoot.meta : metaRoot;
    const metaSafe = (meta && typeof meta === "object" && !Array.isArray(meta)) ? meta : {};

    const normalized = normalizeState(status);
    const branchCount = Object.keys(normalized.branches || {}).length;
    const updatedAt = normalized.updatedAt || "-";
    const summary = `Branches: ${branchCount} • Updated: ${updatedAt}`;
    PENDING_RESTORE = { status: normalized, meta: metaSafe };
    openDashboardRestoreConfirm(summary);
  }
  function bind() {
    $("btnEditOverall")?.addEventListener("click", openOverallEditor);
    $("btnEditBranch")?.addEventListener("click", () => {
      const keys = getBranchKeys();
      if (keys.length === 0) {
        toast("No branches yet. Click New Branch to add one.", "warn");
        return;
      }
      openBranchEditor(keys[0]);
    });

    $("btnNewBranch")?.addEventListener("click", openNewBranch);
    $("nbClose")?.addEventListener("click", closeNewBranch);
    $("nbCancel")?.addEventListener("click", closeNewBranch);
    $("nbCreate")?.addEventListener("click", createBranchFromForm);
    $("nbKey")?.addEventListener("keydown", (e) => { if (e.key === "Enter") createBranchFromForm(); });
    $("nbProgress")?.addEventListener("keydown", (e) => { if (e.key === "Enter") createBranchFromForm(); });
    $("btnServerSettings")?.addEventListener("click", openServerSettings);
    $("btnSyncServer")?.addEventListener("click", saveToServer);
    $("btnRefreshServer")?.addEventListener("click", refreshFromServer);

    $("saveOverall")?.addEventListener("click", saveOverallFromEditor);
    document.querySelectorAll('[data-close="ovOverall"]').forEach(btn => {
      btn.addEventListener("click", () => closeOverlay("ovOverall"));
    });

    $("saveBranch")?.addEventListener("click", saveBranchFromEditor);
    $("bKey")?.addEventListener("change", () => {
      const key = $("bKey").value;
      if (key) openBranchEditor(key);
    });
    document.querySelectorAll('[data-close="ovBranch"]').forEach(btn => {
      btn.addEventListener("click", () => closeOverlay("ovBranch"));
    });

    $("btnCloseServer")?.addEventListener("click", () => closeOverlay("ovServer"));
    $("btnCancelServer")?.addEventListener("click", () => closeOverlay("ovServer"));
    $("btnImportServerSettings")?.addEventListener("click", startImportServerSettings);
    $("svImportFile")?.addEventListener("change", importServerSettingsFromFile);
    $("btnBackupServerSettings")?.addEventListener("click", backupServerSettings);
    $("btnTestServerSettings")?.addEventListener("click", testServerConnection);
    $("btnBackupCopy")?.addEventListener("click", copyBackupSettings);
    document.querySelectorAll('[data-close="ovBackupSettings"]').forEach(btn => {
      btn.addEventListener("click", () => closeOverlay("ovBackupSettings"));
    });
    $("btnSaveServerSettings")?.addEventListener("click", saveServerSettingsFromModal);

    const backupsDropdown = $("backupsDropdown");
    $("btnBackups")?.addEventListener("click", (e) => {
      e.preventDefault();
      e.stopPropagation();
      toggleBackupsMenu();
    });
    $("btnDashboardBackup")?.addEventListener("click", () => {
      setBackupsMenu(false);
      backupDashboardData();
    });
    $("btnDashboardRestore")?.addEventListener("click", () => {
      setBackupsMenu(false);
      startDashboardRestore();
    });
    $("dashboardImportFile")?.addEventListener("change", restoreDashboardFromFile);
    $("btnDashboardBackupCopy")?.addEventListener("click", copyDashboardBackup);
    document.querySelectorAll('[data-close="ovDashboardBackup"]').forEach(btn => {
      btn.addEventListener("click", () => closeOverlay("ovDashboardBackup"));
    });
    $("btnDashboardRestoreConfirm")?.addEventListener("click", confirmDashboardRestore);
    $("btnDashboardRestoreCancel")?.addEventListener("click", cancelDashboardRestore);
    document.querySelectorAll('[data-close="ovDashboardRestoreConfirm"]').forEach(btn => {
      btn.addEventListener("click", cancelDashboardRestore);
    });
    document.addEventListener("click", (e) => {
      if (!backupsDropdown) return;
      if (!backupsDropdown.contains(e.target)) setBackupsMenu(false);
    });
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") setBackupsMenu(false);
    });

    const branchesEl = $("branches");
    branchesEl?.addEventListener("click", (e) => {
      const moveBtn = e.target.closest("[data-move-branch]");
      if (moveBtn) {
        const key = moveBtn.getAttribute("data-branch-key");
        const dir = moveBtn.getAttribute("data-move-branch");
        if (key && dir) moveBranchInView(key, dir);
        return;
      }
      const btn = e.target.closest("[data-edit-branch]");
      if (!btn) return;
      const key = btn.getAttribute("data-edit-branch");
      openBranchEditor(key);
    });
    $("filterSearch")?.addEventListener("input", renderBranches);
    $("filterStatus")?.addEventListener("change", renderBranches);
    $("filterPriority")?.addEventListener("change", renderBranches);
    $("filterOwner")?.addEventListener("change", renderBranches);
    $("filterTag")?.addEventListener("change", renderBranches);
    $("filterClear")?.addEventListener("click", clearFilters);
    if (branchesEl) {
      branchesEl.addEventListener("dragstart", (e) => {
        const handle = e.target.closest(".drag-handle");
        if (!handle) return;
        const item = handle.closest(".branch-item");
        if (!item) return;
        DRAG_KEY = item.getAttribute("data-branch-key");
        item.classList.add("dragging");
        e.dataTransfer.effectAllowed = "move";
        e.dataTransfer.setData("text/plain", DRAG_KEY || "");
      });
      branchesEl.addEventListener("dragover", (e) => {
        const item = e.target.closest(".branch-item");
        if (!item || !DRAG_KEY) return;
        e.preventDefault();
        item.classList.add("drag-over");
      });
      branchesEl.addEventListener("dragleave", (e) => {
        const item = e.target.closest(".branch-item");
        if (!item) return;
        item.classList.remove("drag-over");
      });
      branchesEl.addEventListener("drop", (e) => {
        const item = e.target.closest(".branch-item");
        if (!item) return;
        e.preventDefault();
        const targetKey = item.getAttribute("data-branch-key");
        const dragKey = DRAG_KEY || e.dataTransfer.getData("text/plain");
        if (!dragKey || !targetKey || dragKey === targetKey) {
          clearBranchDragState(branchesEl);
          DRAG_KEY = null;
          return;
        }
        const rect = item.getBoundingClientRect();
        const insertBefore = e.clientY < rect.top + rect.height / 2;
        reorderBranches(dragKey, targetKey, insertBefore);
        clearBranchDragState(branchesEl);
        DRAG_KEY = null;
      });
      branchesEl.addEventListener("dragend", () => {
        clearBranchDragState(branchesEl);
        DRAG_KEY = null;
      });
    }

    $("btnAbout")?.addEventListener("click", () => {
      const el = $("howItWorks");
      if (el) {
        el.style.display = el.style.display === "none" ? "block" : "none";
      }
    });

  }

  async function init() {
    bind();

    const saved = loadLocal();
    if (saved) {
      STATE = normalizeState(saved);
    }
    META = loadMeta();

    const cfg = getServerSettings();
    if (cfg && cfg.readUrl) {
      setLoading(true, "Loading latest server data…");
      await refreshFromServer();
      setLoading(false);
    }

    
    // Autosave safety net (only saves when there are local changes)
    if (!AUTOSAVE_INTERVAL) {
      AUTOSAVE_INTERVAL = setInterval(() => { if (DIRTY) autosaveToServer(); }, 60000);
    }

    document.addEventListener("visibilitychange", () => {
      if (document.visibilityState === "hidden" && DIRTY) autosaveToServer();
    });
    window.addEventListener("pagehide", () => { if (DIRTY) autosaveToServer(); });

    renderAll();
    updateSavePill();
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", init);
  } else {
    init();
  }
})();
</script>

  <div id="loadingOverlay" style="display:none; position:fixed; inset:0; z-index:2000; align-items:center; justify-content:center; background:rgba(0,0,0,.55); backdrop-filter: blur(4px);">
    <div style="min-width:min(520px,92vw); max-width:720px; padding:18px 18px; border-radius:18px; background:rgba(16,22,32,.72); border:1px solid rgba(255,255,255,.10); box-shadow:0 20px 60px rgba(0,0,0,.55);">
      <div style="display:flex; align-items:center; gap:12px;">
        <div style="width:14px; height:14px; border-radius:999px; border:2px solid rgba(255,255,255,.35); border-top-color: rgba(76,175,80,.95); animation:spin 0.9s linear infinite;"></div>
        <div id="loadingText" style="font-weight:700; letter-spacing:.2px;">Loading…</div>
      </div>
      <div style="margin-top:8px; color:rgba(255,255,255,.70); font-size:13px;">If this takes longer than a few seconds, check your Read URL and API key.</div>
    </div>
  </div>

</body>
</html>










